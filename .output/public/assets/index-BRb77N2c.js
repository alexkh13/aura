import{ar as Ot,b5 as ce,n as g,j as Le,aA as K,q as ue,l as Je,w as yr,a2 as gr,aM as F,u as Ye,s as wr,o as T,b1 as H,aT as Mt,aU as At,aO as Tt,b6 as _r,aS as Ge,b7 as Nt,b8 as br,b9 as xt,ba as Xe,aQ as Bt,bb as kr,bc as Ft,aV as X,bd as Ze,be as et,aC as re,aP as Dr,aR as Er,ab as Ir,aE as D,az as V,Q as Z,aB as be,i as tt,r as Lt,a6 as ae,C as ke,aw as L,ak as Cr,b0 as I,b2 as qt,at as jt,as as ye,aF as Ht,c as we,d as Rr,f as Wt,aD as $,af as Sr,an as Pr,am as rt,ay as Or,p as $t,h as le,b3 as de,aj as oe,ac as Mr,a4 as Pe,aq as at,aa as z,a9 as Oe,y as Qt,z as Ar,x as Tr,k as Nr,aN as ve,J as nt,a7 as ne,H as qe,aK as xr,aJ as vt,K as Ut,al as W,b as je,ao as Br,ae as Fr,I as Lr,aG as qr,bf as jr,aL as pt,B as me,m as Hr,a1 as Wr,P as Kt}from"./broadcast-channel-K9QvgciB.js";function De(e,r){if(e===r)return!0;if(e&&r&&typeof e=="object"&&typeof r=="object"){if(e.constructor!==r.constructor)return!1;var a,t;if(Array.isArray(e)){if(a=e.length,a!==r.length)return!1;for(t=a;t--!==0;)if(!De(e[t],r[t]))return!1;return!0}if(e.constructor===RegExp)return e.source===r.source&&e.flags===r.flags;if(e.valueOf!==Object.prototype.valueOf)return e.valueOf()===r.valueOf();if(e.toString!==Object.prototype.toString)return e.toString()===r.toString();var n=Object.keys(e);if(a=n.length,a!==Object.keys(r).length)return!1;for(t=a;t--!==0;)if(!Object.prototype.hasOwnProperty.call(r,n[t]))return!1;for(t=a;t--!==0;){var s=n[t];if(!De(e[s],r[s]))return!1}return!0}return e!==e&&r!==r}function k(e){var r=e.split("-"),a="RxDB";return r.forEach(t=>{a+=Ot(t)}),a+="Plugin",new Error(`You are using a function which must be overwritten by a plugin.
        You should either prevent the usage of this function or add the plugin via:
            import { `+a+" } from 'rxdb/plugins/"+e+`';
            addRxPlugin(`+a+`);
        `)}function rs(e){var r={name:e.name,message:e.message,rxdb:e.rxdb,parameters:e.parameters,extensions:e.extensions,code:e.code,url:e.url,stack:e.stack?e.stack.replace(/\n/g,` 
 `):void 0};return r}var Vt=(function(){function e(a,t){if(this.jsonSchema=a,this.hashFunction=t,this.indexes=$r(this.jsonSchema),this.primaryPath=Je(this.jsonSchema.primaryKey),!a.properties[this.primaryPath].maxLength)throw g("SC39",{schema:a});this.finalFields=yr(this.jsonSchema)}var r=e.prototype;return r.validateChange=function(t,n){this.finalFields.forEach(s=>{if(!De(t[s],n[s]))throw g("DOC9",{dataBefore:t,dataAfter:n,fieldName:s,schema:this.jsonSchema})})},r.getDocumentPrototype=function(){var t={},n=Le(this.jsonSchema,"");return Object.keys(n).forEach(s=>{var i=s;t.__defineGetter__(s,function(){if(!(!this.get||typeof this.get!="function")){var o=this.get(i);return o}}),Object.defineProperty(t,s+"$",{get:function(){return this.get$(i)},enumerable:!1,configurable:!1}),Object.defineProperty(t,s+"$$",{get:function(){return this.get$$(i)},enumerable:!1,configurable:!1}),Object.defineProperty(t,s+"_",{get:function(){return this.populate(i)},enumerable:!1,configurable:!1})}),K(this,"getDocumentPrototype",()=>t),t},r.getPrimaryOfDocumentData=function(t){return ue(this.jsonSchema,t)},ce(e,[{key:"version",get:function(){return this.jsonSchema.version}},{key:"defaultValues",get:function(){var a={};return Object.entries(this.jsonSchema.properties).filter(([,t])=>Object.prototype.hasOwnProperty.call(t,"default")).forEach(([t,n])=>a[t]=n.default),K(this,"defaultValues",a)}},{key:"hash",get:function(){return K(this,"hash",this.hashFunction(JSON.stringify(this.jsonSchema)))}}])})();function $r(e){return(e.indexes||[]).map(r=>gr(r)?r:[r])}function as(e){var r=e.version?e.version:0,a=0;return new Array(r).fill(0).map(()=>a++)}function Qr(e,r,a=!0){a&&F("preCreateRxSchema",e);var t=Ye(e);t=wr(t),T.deepFreezeWhenDevMode(t);var n=new Vt(t,r);return F("createRxSchema",n),n}var zt={now:function(){return(zt.delegate||Date).now()},delegate:void 0},Ur=Array.isArray,Kr=Object.getPrototypeOf,Vr=Object.prototype,zr=Object.keys;function Jr(e){if(e.length===1){var r=e[0];if(Ur(r))return{args:r,keys:null};if(Yr(r)){var a=zr(r);return{args:a.map(function(t){return r[t]}),keys:a}}}return{args:e,keys:null}}function Yr(e){return e&&typeof e=="object"&&Kr(e)===Vr}var Gr=Array.isArray;function Xr(e,r){return Gr(r)?e.apply(void 0,Mt([],At(r))):e(r)}function Zr(e){return H(function(r){return Xr(e,r)})}function ea(e,r){return e.reduce(function(a,t,n){return a[t]=r[n],a},{})}function ta(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];var a=Tt(e),t=_r(e),n=Jr(e),s=n.args,i=n.keys;if(s.length===0)return Ge([],a);var o=new Nt(ra(s,a,i?function(c){return ea(i,c)}:Xe));return t?o.pipe(Zr(t)):o}function ra(e,r,a){return a===void 0&&(a=Xe),function(t){yt(r,function(){for(var n=e.length,s=new Array(n),i=n,o=n,c=function(u){yt(r,function(){var l=Ge(e[u],r),p=!1;l.subscribe(xt(t,function(f){s[u]=f,p||(p=!0,o--),o||t.next(a(s.slice()))},function(){--i||t.complete()}))},t)},h=0;h<n;h++)c(h)},t)}}function yt(e,r,a){e?br(a,e,r):r()}var aa=new Nt(function(e){return e.complete()});function He(e,r){return r===void 0&&(r=Xe),e=e??na,Bt(function(a,t){var n,s=!0;a.subscribe(xt(t,function(i){var o=r(i);(s||!e(n,o))&&(s=!1,n=o,t.next(i))}))})}function na(e,r){return e===r}var sa=kr(function(e){return function(){e(this),this.name="EmptyError",this.message="no elements in sequence"}}),te=(function(e){Ft(r,e);function r(a){var t=e.call(this)||this;return t._value=a,t}return Object.defineProperty(r.prototype,"value",{get:function(){return this.getValue()},enumerable:!1,configurable:!0}),r.prototype._subscribe=function(a){var t=e.prototype._subscribe.call(this,a);return!t.closed&&a.next(this._value),t},r.prototype.getValue=function(){var a=this,t=a.hasError,n=a.thrownError,s=a._value;if(t)throw n;return this._throwIfClosed(),s},r.prototype.next=function(a){e.prototype.next.call(this,this._value=a)},r})(X),ia=(function(e){Ft(r,e);function r(a,t,n){a===void 0&&(a=1/0),t===void 0&&(t=1/0),n===void 0&&(n=zt);var s=e.call(this)||this;return s._bufferSize=a,s._windowTime=t,s._timestampProvider=n,s._buffer=[],s._infiniteTimeWindow=!0,s._infiniteTimeWindow=t===1/0,s._bufferSize=Math.max(1,a),s._windowTime=Math.max(1,t),s}return r.prototype.next=function(a){var t=this,n=t.isStopped,s=t._buffer,i=t._infiniteTimeWindow,o=t._timestampProvider,c=t._windowTime;n||(s.push(a),!i&&s.push(o.now()+c)),this._trimBuffer(),e.prototype.next.call(this,a)},r.prototype._subscribe=function(a){this._throwIfClosed(),this._trimBuffer();for(var t=this._innerSubscribe(a),n=this,s=n._infiniteTimeWindow,i=n._buffer,o=i.slice(),c=0;c<o.length&&!a.closed;c+=s?1:2)a.next(o[c]);return this._checkFinalizedStatuses(a),t},r.prototype._trimBuffer=function(){var a=this,t=a._bufferSize,n=a._timestampProvider,s=a._buffer,i=a._infiniteTimeWindow,o=(i?1:2)*t;if(t<1/0&&o<s.length&&s.splice(0,s.length-o),!i){for(var c=n.now(),h=0,u=1;u<s.length&&s[u]<=c;u+=2)h=u;h&&s.splice(0,h+1)}},r})(X);function oa(e){e===void 0&&(e={});var r=e.connector,a=r===void 0?function(){return new X}:r,t=e.resetOnError,n=t===void 0?!0:t,s=e.resetOnComplete,i=s===void 0?!0:s,o=e.resetOnRefCountZero,c=o===void 0?!0:o;return function(h){var u,l,p,f=0,m=!1,v=!1,d=function(){l?.unsubscribe(),l=void 0},y=function(){d(),u=p=void 0,m=v=!1},w=function(){var _=u;y(),_?.unsubscribe()};return Bt(function(_,C){f++,!v&&!m&&d();var R=p=p??a();C.add(function(){f--,f===0&&!v&&!m&&(l=Ae(w,c))}),R.subscribe(C),!u&&f>0&&(u=new Ze({next:function(N){return R.next(N)},error:function(N){v=!0,d(),l=Ae(y,n,N),R.error(N)},complete:function(){m=!0,d(),l=Ae(y,i),R.complete()}}),et(_).subscribe(u))})(h)}}function Ae(e,r){for(var a=[],t=2;t<arguments.length;t++)a[t-2]=arguments[t];if(r===!0){e();return}if(r!==!1){var n=new Ze({next:function(){n.unsubscribe(),e()}});return et(r.apply(void 0,Mt([],At(a)))).subscribe(n)}}function Jt(e,r,a){var t,n,s,i,o=!1;return e&&typeof e=="object"?(t=e.bufferSize,i=t===void 0?1/0:t,n=e.windowTime,r=n===void 0?1/0:n,s=e.refCount,o=s===void 0?!1:s,a=e.scheduler):i=e??1/0,oa({connector:function(){return new ia(i,r,a)},resetOnError:!0,resetOnComplete:!1,resetOnRefCountZero:o})}function ca(e){return e.documentData?e.documentData:e.previousDocumentData}function ua(e){switch(e.operation){case"INSERT":return{operation:e.operation,id:e.documentId,doc:e.documentData,previous:null};case"UPDATE":return{operation:e.operation,id:e.documentId,doc:T.deepFreezeWhenDevMode(e.documentData),previous:e.previousDocumentData?e.previousDocumentData:"UNKNOWN"};case"DELETE":return{operation:e.operation,id:e.documentId,doc:null,previous:e.previousDocumentData}}}var ha=new Map;function Yt(e){return re(ha,e,()=>{for(var r=new Array(e.events.length),a=e.events,t=e.collectionName,n=e.isLocal,s=T.deepFreezeWhenDevMode,i=0;i<a.length;i++){var o=a[i];r[i]={documentId:o.documentId,collectionName:t,isLocal:n,operation:o.operation,documentData:s(o.documentData),previousDocumentData:s(o.previousDocumentData)}}return r})}function Ee(e,r){return new Promise(function(a,t){var n=new Ze({next:function(s){a(s),n.unsubscribe()},error:t,complete:function(){t(new sa)}});e.subscribe(n)})}function la(){for(var e=[],r=0;r<arguments.length;r++)e[r]=arguments[r];var a=Tt(e),t=Dr(e,1/0),n=e;return n.length?n.length===1?et(n[0]):Er(t)(Ge(n,a)):aa}var fa=(function(){function e(a,t,n,s){this.queueByDocId=new Map,this.isRunning=!1,this.storageInstance=a,this.primaryPath=t,this.preWrite=n,this.postWrite=s}var r=e.prototype;return r.addWrite=function(t,n){var s=t[this.primaryPath],i=re(this.queueByDocId,s,()=>[]),o=new Promise((c,h)=>{var u={lastKnownDocumentState:t,modifier:n,resolve:c,reject:h};D(i).push(u),this.triggerRun()});return o},r.triggerRun=async function(){if(!(this.isRunning===!0||this.queueByDocId.size===0)){this.isRunning=!0;var t=[],n=this.queueByDocId;this.queueByDocId=new Map,await Promise.all(Array.from(n.entries()).map(async([i,o])=>{var c=ma(o.map(l=>l.lastKnownDocumentState)),h=c;for(var u of o)try{h=await u.modifier(V(h))}catch(l){u.reject(l),u.reject=()=>{},u.resolve=()=>{}}try{await this.preWrite(h,c)}catch(l){o.forEach(p=>p.reject(l));return}t.push({previous:c,document:h})}));var s=t.length>0?await this.storageInstance.bulkWrite(t,"incremental-write"):{error:[]};return await Promise.all(Z(this.primaryPath,t,s).map(i=>{var o=i[this.primaryPath];this.postWrite(i);var c=be(n,o);c.forEach(h=>h.resolve(i))})),s.error.forEach(i=>{var o=i.documentId,c=be(n,o),h=tt(i);if(h){var u=re(this.queueByDocId,o,()=>[]);c.reverse().forEach(p=>{p.lastKnownDocumentState=D(h.documentInDb),D(u).unshift(p)})}else{var l=Lt(i);c.forEach(p=>p.reject(l))}}),this.isRunning=!1,this.triggerRun()}},e})();function gt(e){var r=async a=>{var t=Ir(a);t._deleted=a._deleted;var n=await e(t),s=Object.assign({},n,{_meta:a._meta,_attachments:a._attachments,_rev:a._rev,_deleted:typeof n._deleted<"u"?n._deleted:a._deleted});return typeof s._deleted>"u"&&(s._deleted=!1),s};return r}function ma(e){var r=e[0],a=ae(r._rev);return e.forEach(t=>{var n=ae(t._rev);n>a&&(r=t,a=n)}),r}var st={get primaryPath(){var e=this;if(e.isInstanceOfRxDocument)return e.collection.schema.primaryPath},get primary(){var e=this;if(e.isInstanceOfRxDocument)return e._data[e.primaryPath]},get revision(){var e=this;if(e.isInstanceOfRxDocument)return e._data._rev},get deleted$(){var e=this;if(e.isInstanceOfRxDocument)return e.$.pipe(H(r=>r._data._deleted))},get deleted$$(){var e=this,r=e.collection.database.getReactivityFactory();return r.fromObservable(e.deleted$,e.getLatest().deleted,e.collection.database)},get deleted(){var e=this;if(e.isInstanceOfRxDocument)return e._data._deleted},getLatest(){var e=this.collection._docCache.getLatestDocumentData(this.primary);return this.collection._docCache.getCachedRxDocument(e)},get $(){var e=this,r=this.primary;return e.collection.eventBulks$.pipe(I(a=>!a.isLocal),H(a=>a.events.find(t=>t.documentId===r)),I(a=>!!a),H(a=>ca(D(a))),qt(e.collection._docCache.getLatestDocumentData(r)),He((a,t)=>a._rev===t._rev),H(a=>this.collection._docCache.getCachedRxDocument(a)),Jt(Ht))},get $$(){var e=this,r=e.collection.database.getReactivityFactory();return r.fromObservable(e.$,e.getLatest()._data,e.collection.database)},get$(e){if(T.isDevMode()){if(e.includes(".item."))throw g("DOC1",{path:e});if(e===this.primaryPath)throw g("DOC2");if(this.collection.schema.finalFields.includes(e))throw g("DOC3",{path:e});var r=Le(this.collection.schema.jsonSchema,e);if(!r)throw g("DOC4",{path:e})}return this.$.pipe(H(a=>jt(a,e)),He())},get$$(e){var r=this.get$(e),a=this.collection.database.getReactivityFactory();return a.fromObservable(r,this.getLatest().get(e),this.collection.database)},populate(e){var r=Le(this.collection.schema.jsonSchema,e),a=this.get(e);if(!a)return Cr;if(!r)throw g("DOC5",{path:e});if(!r.ref)throw g("DOC6",{path:e,schemaObj:r});var t=this.collection.database.collections[r.ref];if(!t)throw g("DOC7",{ref:r.ref,path:e,schemaObj:r});return r.type==="array"?t.findByIds(a).exec().then(n=>{var s=n.values();return Array.from(s)}):t.findOne(a).exec()},get(e){return Xt(this,e)},toJSON(e=!1){if(e)return T.deepFreezeWhenDevMode(this._data);var r=L(this._data);return delete r._rev,delete r._attachments,delete r._deleted,delete r._meta,T.deepFreezeWhenDevMode(r)},toMutableJSON(e=!1){return V(this.toJSON(e))},update(e){throw k("update")},incrementalUpdate(e){throw k("update")},updateCRDT(e){throw k("crdt")},putAttachment(){throw k("attachments")},putAttachmentBase64(){throw k("attachments")},getAttachment(){throw k("attachments")},allAttachments(){throw k("attachments")},get allAttachments$(){throw k("attachments")},async modify(e,r){var a=this._data,t=await gt(e)(a);return this._saveData(t,a)},incrementalModify(e,r){return this.collection.incrementalWriteQueue.addWrite(this._data,gt(e)).then(a=>this.collection._docCache.getCachedRxDocument(a))},patch(e){var r=this._data,a=V(r);return Object.entries(e).forEach(([t,n])=>{a[t]=n}),this._saveData(a,r)},incrementalPatch(e){return this.incrementalModify(r=>(Object.entries(e).forEach(([a,t])=>{r[a]=t}),r))},async _saveData(e,r){if(e=L(e),this._data._deleted)throw g("DOC11",{id:this.primary,document:this});await Gt(this.collection,e,r);var a=[{previous:r,document:e}],t=await this.collection.storageInstance.bulkWrite(a,"rx-document-save-data"),n=t.error[0];return ke(this.collection,this.primary,e,n),await this.collection._runHooks("post","save",e,this),this.collection._docCache.getCachedRxDocument(Z(this.collection.schema.primaryPath,a,t)[0])},async remove(){if(this.deleted)return Promise.reject(g("DOC13",{document:this,id:this.primary}));var e=await this.collection.bulkRemove([this]);if(e.error.length>0){var r=e.error[0];ke(this.collection,this.primary,this._data,r)}return e.success[0]},incrementalRemove(){return this.incrementalModify(async e=>(await this.collection._runHooks("pre","remove",e,this),e._deleted=!0,e)).then(async e=>(await this.collection._runHooks("post","remove",e._data,e),e))},close(){throw g("DOC14")}};function da(e=st){var r=function(t,n){this.collection=t,this._data=n,this._propertyCache=new Map,this.isInstanceOfRxDocument=!0};return r.prototype=e,r}function va(e,r,a){var t=new e(r,a);return F("createRxDocument",t),t}function Gt(e,r,a){return r._meta=Object.assign({},a._meta,r._meta),T.isDevMode()&&e.schema.validateChange(a,r),e._runHooks("pre","save",r,a)}function Xt(e,r){return re(e._propertyCache,r,()=>{var a=jt(e._data,r);if(typeof a!="object"||a===null||Array.isArray(a))return T.deepFreezeWhenDevMode(a);var t=new Proxy(L(a),{get(n,s){if(typeof s!="string")return n[s];var i=s.charAt(s.length-1);if(i==="$")if(s.endsWith("$$")){var o=s.slice(0,-2);return e.get$$(ye(r+"."+o))}else{var c=s.slice(0,-1);return e.get$(ye(r+"."+c))}else if(i==="_"){var h=s.slice(0,-1);return e.populate(ye(r+"."+h))}else{var u=n[s];return typeof u=="number"||typeof u=="string"||typeof u=="boolean"?u:Xt(e,ye(r+"."+s))}}});return t})}function it(e){return e[e.length-1]}function pa(e){const r=typeof e;return e!==null&&(r==="object"||r==="function")}function wt(e,r,a){if(Array.isArray(r)&&(r=r.join(".")),!pa(e)||typeof r!="string")return e;const t=r.split(".");if(t.length===0)return a;for(let n=0;n<t.length;n++){const s=t[n];if(ya(e,s)?e=n===t.length-1?void 0:null:e=e[s],e==null){if(n!==t.length-1)return a;break}}return e===void 0?a:e}function ya(e,r){if(typeof r!="number"&&Array.isArray(e)){const a=Number.parseInt(r,10);return Number.isInteger(a)&&e[a]===e[r]}return!1}const Zt=e=>!!e.queryParams.limit,ga=e=>e.queryParams.limit===1,wa=e=>!!(e.queryParams.skip&&e.queryParams.skip>0),_a=e=>e.changeEvent.operation==="DELETE",ba=e=>e.changeEvent.operation==="INSERT",ka=e=>e.changeEvent.operation==="UPDATE",Da=e=>Zt(e)&&e.previousResults.length>=e.queryParams.limit,Ea=e=>{const r=e.queryParams.sortFields,a=e.changeEvent.previous,t=e.changeEvent.doc;if(!t)return!1;if(!a)return!0;for(let n=0;n<r.length;n++){const s=r[n],i=wt(a,s),o=wt(t,s);if(i!==o)return!0}return!1},Ia=e=>{const r=e.changeEvent.id;if(e.keyDocumentMap)return e.keyDocumentMap.has(r);{const a=e.queryParams.primaryKey,t=e.previousResults;for(let n=0;n<t.length;n++)if(t[n][a]===r)return!0;return!1}},Ca=e=>{const r=e.previousResults[0];return!!(r&&r[e.queryParams.primaryKey]===e.changeEvent.id)},Ra=e=>{const r=it(e.previousResults);return!!(r&&r[e.queryParams.primaryKey]===e.changeEvent.id)},Sa=e=>{const r=e.changeEvent.previous;if(!r)return!1;const a=e.previousResults[0];return a?a[e.queryParams.primaryKey]===e.changeEvent.id?!0:e.queryParams.sortComparator(r,a)<0:!1},Pa=e=>{const r=e.changeEvent.previous;if(!r)return!1;const a=it(e.previousResults);return a?a[e.queryParams.primaryKey]===e.changeEvent.id?!0:e.queryParams.sortComparator(r,a)>0:!1},Oa=e=>{const r=e.changeEvent.doc;if(!r)return!1;const a=e.previousResults[0];return a?a[e.queryParams.primaryKey]===e.changeEvent.id?!0:e.queryParams.sortComparator(r,a)<0:!1},Ma=e=>{const r=e.changeEvent.doc;if(!r)return!1;const a=it(e.previousResults);return a?a[e.queryParams.primaryKey]===e.changeEvent.id?!0:e.queryParams.sortComparator(r,a)>0:!1},Aa=e=>{const r=e.changeEvent.previous;return r?e.queryParams.queryMatcher(r):!1},Ta=e=>{const r=e.changeEvent.doc;return r?e.queryParams.queryMatcher(r):!1},Na=e=>e.previousResults.length===0,xa={0:ba,1:ka,2:_a,3:Zt,4:ga,5:wa,6:Na,7:Da,8:Ca,9:Ra,10:Ea,11:Ia,12:Sa,13:Pa,14:Oa,15:Ma,16:Aa,17:Ta};function Ba(e,r,a,t){var n=e.length,s=n-1,i=0;if(n===0)return e.push(r),0;for(var o;t<=s;)i=t+(s-t>>1),o=e[i],a(o,r)<=0?t=i+1:s=i-1;return a(o,r)<=0&&i++,e.splice(i,0,r),i}const Fa=e=>{},ot=e=>{e.previousResults.unshift(e.changeEvent.doc),e.keyDocumentMap&&e.keyDocumentMap.set(e.changeEvent.id,e.changeEvent.doc)},ct=e=>{e.previousResults.push(e.changeEvent.doc),e.keyDocumentMap&&e.keyDocumentMap.set(e.changeEvent.id,e.changeEvent.doc)},ut=e=>{const r=e.previousResults.shift();e.keyDocumentMap&&r&&e.keyDocumentMap.delete(r[e.queryParams.primaryKey])},ht=e=>{const r=e.previousResults.pop();e.keyDocumentMap&&r&&e.keyDocumentMap.delete(r[e.queryParams.primaryKey])},La=e=>{ut(e),ct(e)},qa=e=>{ht(e),ot(e)},ja=e=>{ut(e),ot(e)},Ha=e=>{ht(e),ct(e)},er=e=>{e.keyDocumentMap&&e.keyDocumentMap.delete(e.changeEvent.id);const r=e.queryParams.primaryKey,a=e.previousResults;for(let t=0;t<a.length;t++)if(a[t][r]===e.changeEvent.id){a.splice(t,1);break}},Wa=e=>{const r=e.changeEvent.doc,a=e.queryParams.primaryKey,t=e.previousResults;for(let n=0;n<t.length;n++)if(t[n][a]===e.changeEvent.id){t[n]=r,e.keyDocumentMap&&e.keyDocumentMap.set(e.changeEvent.id,r);break}},$a=e=>{const r={_id:"wrongHuman"+new Date().getTime()};e.previousResults.length=0,e.previousResults.push(r),e.keyDocumentMap&&(e.keyDocumentMap.clear(),e.keyDocumentMap.set(r._id,r))},tr=e=>{const r=e.changeEvent.id,a=e.changeEvent.doc;if(e.keyDocumentMap){if(e.keyDocumentMap.has(r))return;e.keyDocumentMap.set(r,a)}else if(e.previousResults.find(n=>n[e.queryParams.primaryKey]===r))return;Ba(e.previousResults,a,e.queryParams.sortComparator,0)},Qa=e=>{er(e),tr(e)},Ua=e=>{throw new Error("Action runFullQueryAgain must be implemented by yourself")},Ka=e=>{throw new Error("Action unknownAction should never be called")},Va=["doNothing","insertFirst","insertLast","removeFirstItem","removeLastItem","removeFirstInsertLast","removeLastInsertFirst","removeFirstInsertFirst","removeLastInsertLast","removeExisting","replaceExisting","alwaysWrong","insertAtSortPosition","removeExistingAndInsertAtSortPosition","runFullQueryAgain","unknownAction"],za={doNothing:Fa,insertFirst:ot,insertLast:ct,removeFirstItem:ut,removeLastItem:ht,removeFirstInsertLast:La,removeLastInsertFirst:qa,removeFirstInsertFirst:ja,removeLastInsertLast:Ha,removeExisting:er,replaceExisting:Wa,alwaysWrong:$a,insertAtSortPosition:tr,removeExistingAndInsertAtSortPosition:Qa,runFullQueryAgain:Ua,unknownAction:Ka},Ja=40;function Te(e){return e.charCodeAt(0)-Ja}function Ya(e){return e?"1":"0"}function _t(e,r){const a=[];for(let t=0,n=e.length;t<n;t+=r)a.push(e.substring(t,t+r));return a}function Ga(e){const r=new Map,t=2+parseInt(e.charAt(0)+e.charAt(1),10)*2,n=e.substring(2,t),s=_t(n,2);for(let v=0;v<s.length;v++){const d=s[v],y=d.charAt(0),w=Te(d.charAt(1));r.set(y,w)}const i=e.substring(t,e.length-3),o=_t(i,4);for(let v=0;v<o.length;v++){const d=o[v],y=d.charAt(0),w=d.charAt(1),_=d.charAt(2),C=Te(d.charAt(3));if(!r.has(w))throw new Error("missing node with id "+w);if(!r.has(_))throw new Error("missing node with id "+_);const R=r.get(w),N=r.get(_),x={l:C,0:R,1:N};r.set(y,x)}const c=e.slice(-3),h=c.charAt(0),u=c.charAt(1),l=Te(c.charAt(2)),p=r.get(h),f=r.get(u);return{l,0:p,1:f}}function Xa(e,r,a){let t=e,n=e.l;for(;;){const s=r[n](a),i=Ya(s);if(t=t[i],typeof t=="number"||typeof t=="string")return t;n=t.l}}const Za="14a1b,c+d2e5f0g/h.i4j*k-l)m(n6oeh6pnm6qen6ril6snh6tin6ubo9vce9wmh9xns9yne9zmi9{cm9|ad9}cp9~aq9ae9¡bf9¢bq9£cg9¤ck9¥cn9¦nd9§np9¨nq9©nf9ªng9«nm9¬nk9­mr9®ms9¯mt9°mj9±mk9²ml9³mn9´mc8µ³{8¶¯}8·°¤8¸³§8¹mn8º³«8»³m8¼m´4½z²4¾³w4¿zµ4À¯¶4Á°·4Â³º4Ã³¸4Äm¹4Åv¤7Æyn7ÇÀÁ7È~7É¥¤7ÊÃÄ7Ë¨n7Ìº¹7Í­°7Î®m7Ï¯°7Ð±m7Ñ³m7Ò¼m5ÓÄm5Ô¹m5Õ½°5Ö¾m5×¿°5ØÇÏ5ÙÂm5ÚÊÑ5Û±m5Üºm5ÝÌÑ5ÞÕÍ2ß|2à¡u2á£Å2âÖÎ2ã¦Æ2ä©x2åªÆ2æ×Ø2ç|È2è¡¢2é£É2ê¤¥2ëÙÚ2ì¦Ë2í©n2îªn2ïÛÐ2ðÜÝ2ñ¬n2òÒÓ/óan/ôbn/õcn/öÞâ/÷ßã/øàä/ùáå/úæë/ûçì/üèí/ýéî/þÍÎ/ÿÏÑ/ĀòÔ,ācn,Ăöï,ă¤ñ,Ąúð,ąêñ,ĆþÐ,ćÿÑ,Ĉac0ĉbc0Ċóõ0ċôā0Čßá0čà¤0Ďçé0ďèê0Đ÷ù0đøă0Ēûý0ēüą0ĔmÒ-ĕmĀ-ĖÞæ-ėČĎ-Ęčď-ęĂĄ-ĚĐĒ-ěđē-Ĝ²»-ĝÍÏ-ĞĆć-ğ²³-ĠĔĈ3ġĕĊ3ĢĖė3ģęĚ3ĤĢĝ(ĥĜğ(ĦģĞ(ħĠġ+Ĩĉċ+ĩĤĦ+ĪĘě+īħĨ1ĬĩĪ1ĭĬī*Įĥm*ĭĮ.";let Ne;function en(){return Ne||(Ne=Ga(Za)),Ne}const tn=e=>Xa(en(),xa,e);function rn(e){const r=tn(e);return Va[r]}function an(e,r,a,t,n){const s=za[e];return s({queryParams:r,changeEvent:a,previousResults:t,keyDocumentMap:n}),t}function nn(e,r){return!r.sort||r.sort.length===0?[e]:r.sort.map(a=>Object.keys(a)[0])}var sn=new WeakMap;function on(e){return re(sn,e,()=>{var r=e.collection,a=we(r.storageInstance.schema,V(e.mangoQuery)),t=r.schema.primaryPath,n=Rr(r.schema.jsonSchema,a),s=(h,u)=>{var l={docA:h,docB:u};return n(l.docA,l.docB)},i=Wt(r.schema.jsonSchema,a),o=h=>{var u={doc:h};return i(u.doc)},c={primaryKey:e.collection.schema.primaryPath,skip:a.skip,limit:a.limit,sortFields:nn(t,a),sortComparator:s,queryMatcher:o};return c})}function cn(e,r){if(!e.collection.database.eventReduce)return{runFullQueryAgain:!0};for(var a=on(e),t=D(e._result).docsData.slice(0),n=D(e._result).docsDataMap,s=!1,i=[],o=0;o<r.length;o++){var c=r[o],h=ua(c);h&&i.push(h)}var u=i.find(l=>{var p={queryParams:a,changeEvent:l,previousResults:t,keyDocumentMap:n},f=rn(p);if(f==="runFullQueryAgain")return!0;if(f!=="doNothing")return s=!0,an(f,a,l,t,n),!1});return u?{runFullQueryAgain:!0}:{runFullQueryAgain:!1,changed:s,newResults:t}}var un=(function(){function e(){this._map=new Map}var r=e.prototype;return r.getByQuery=function(t){var n=t.toString(),s=re(this._map,n,()=>t);return s},e})();function hn(){return new un}function bt(e,r){r.uncached=!0;var a=r.toString();e._map.delete(a)}function ln(e){return e.refCount$.observers.length}var fn=100,mn=30*1e3,dn=(e,r)=>(a,t)=>{if(!(t._map.size<e)){var n=$()-r,s=[],i=Array.from(t._map.values());for(var o of i)if(!(ln(o)>0)){if(o._lastEnsureEqual===0&&o._creationTime<n){bt(t,o);continue}s.push(o)}var c=s.length-e;if(!(c<=0)){var h=s.sort((l,p)=>l._lastEnsureEqual-p._lastEnsureEqual),u=h.slice(0,c);u.forEach(l=>bt(t,l))}}},rr=dn(fn,mn),xe=new WeakSet;function vn(e){xe.has(e)||(xe.add(e),Sr().then(()=>Pr(200)).then(()=>{e.closed||e.cacheReplacementPolicy(e,e._queryCache),xe.delete(e)}))}var pn=(function(){function e(a,t,n){this.cacheItemByDocId=new Map,this.tasks=new Set,this.registry=typeof FinalizationRegistry=="function"?new FinalizationRegistry(s=>{var i=s.docId,o=this.cacheItemByDocId.get(i);o&&(o[0].delete(s.revisionHeight+s.lwt+""),o[0].size===0&&this.cacheItemByDocId.delete(i))}):void 0,this.primaryPath=a,this.changes$=t,this.documentCreator=n,t.subscribe(s=>{this.tasks.add(()=>{for(var i=this.cacheItemByDocId,o=0;o<s.length;o++){var c=s[o],h=i.get(c.documentId);if(h){var u=c.documentData;u||(u=c.previousDocumentData),h[1]=u}}}),this.tasks.size<=1&&rt().then(()=>{this.processTasks()})})}var r=e.prototype;return r.processTasks=function(){if(this.tasks.size!==0){var t=Array.from(this.tasks);t.forEach(n=>n()),this.tasks.clear()}},r.getLatestDocumentData=function(t){this.processTasks();var n=be(this.cacheItemByDocId,t);return n[1]},r.getLatestDocumentDataIfExists=function(t){this.processTasks();var n=this.cacheItemByDocId.get(t);if(n)return n[1]},ce(e,[{key:"getCachedRxDocuments",get:function(){var a=kt(this);return K(this,"getCachedRxDocuments",a)}},{key:"getCachedRxDocument",get:function(){var a=kt(this);return K(this,"getCachedRxDocument",t=>a([t])[0])}}])})();function kt(e){var r=e.primaryPath,a=e.cacheItemByDocId,t=e.registry,n=T.deepFreezeWhenDevMode,s=e.documentCreator,i=o=>{for(var c=new Array(o.length),h=[],u=0;u<o.length;u++){var l=o[u],p=l[r],f=ae(l._rev),m=void 0,v=void 0,d=a.get(p);d?(m=d[0],v=m.get(f+l._meta.lwt+"")):(m=new Map,d=[m,l],a.set(p,d));var y=v?v.deref():void 0;y||(l=n(l),y=s(l),m.set(f+l._meta.lwt+"",gn(y)),t&&h.push(y)),c[u]=y}return h.length>0&&t&&(e.tasks.add(()=>{for(var w=0;w<h.length;w++){var _=h[w];t.register(_,{docId:_.primary,revisionHeight:ae(_.revision),lwt:_._data._meta.lwt})}}),e.tasks.size<=1&&rt().then(()=>{e.processTasks()})),c};return i}function We(e,r){var a=e.getCachedRxDocuments;return a(r)}var yn=typeof WeakRef=="function",gn=yn?wn:_n;function wn(e){return new WeakRef(e)}function _n(e){return{deref(){return e}}}var Dt=(function(){function e(a,t,n){this.time=$(),this.query=a,this.count=n,this.documents=We(this.query.collection._docCache,t)}var r=e.prototype;return r.getValue=function(t){var n=this.query.op;if(n==="count")return this.count;if(n==="findOne"){var s=this.documents.length===0?null:this.documents[0];if(!s&&t)throw g("QU10",{collection:this.query.collection.name,query:this.query.mangoQuery,op:n});return s}else return n==="findByIds"?this.docsMap:this.documents.slice(0)},ce(e,[{key:"docsData",get:function(){return K(this,"docsData",this.documents.map(a=>a._data))}},{key:"docsDataMap",get:function(){var a=new Map;return this.documents.forEach(t=>{a.set(t.primary,t._data)}),K(this,"docsDataMap",a)}},{key:"docsMap",get:function(){for(var a=new Map,t=this.documents,n=0;n<t.length;n++){var s=t[n];a.set(s.primary,s)}return K(this,"docsMap",a)}}])})(),bn=0,kn=function(){return++bn},ar=(function(){function e(a,t,n,s={}){this.id=kn(),this._execOverDatabaseCount=0,this._creationTime=$(),this._lastEnsureEqual=0,this.uncached=!1,this.refCount$=new te(null),this._result=null,this._latestChangeEvent=-1,this._ensureEqualQueue=oe,this.op=a,this.mangoQuery=t,this.collection=n,this.other=s,t||(this.mangoQuery=_e()),this.isFindOneByIdQuery=Cn(this.collection.schema.primaryPath,t)}var r=e.prototype;return r._setResultData=function(t){if(typeof t>"u")throw g("QU18",{database:this.collection.database.name,collection:this.collection.name});if(typeof t=="number"){this._result=new Dt(this,[],t);return}else t instanceof Map&&(t=Array.from(t.values()));var n=new Dt(this,t,t.length);this._result=n},r._execOverDatabase=async function(){if(this._execOverDatabaseCount=this._execOverDatabaseCount+1,this.op==="count"){var t=this.getPreparedQuery(),n=await this.collection.storageInstance.count(t);if(n.mode==="slow"&&!this.collection.database.allowSlowCount)throw g("QU14",{collection:this.collection,queryObj:this.mangoQuery});return n.count}if(this.op==="findByIds"){var s=D(this.mangoQuery.selector)[this.collection.schema.primaryPath].$in,i=new Map,o=[];if(s.forEach(u=>{var l=this.collection._docCache.getLatestDocumentDataIfExists(u);if(l){if(!l._deleted){var p=this.collection._docCache.getCachedRxDocument(l);i.set(u,p)}}else o.push(u)}),o.length>0){var c=await this.collection.storageInstance.findDocumentsById(o,!1);c.forEach(u=>{var l=this.collection._docCache.getCachedRxDocument(u);i.set(l.primary,l)})}return i}var h=In(this);return h.then(u=>u)},r.exec=async function(t){if(t&&this.op!=="findOne")throw g("QU9",{collection:this.collection.name,query:this.mangoQuery,op:this.op});await Et(this);var n=D(this._result);return n.getValue(t)},r.toString=function(){var t=Or({op:this.op,query:we(this.collection.schema.jsonSchema,this.mangoQuery),other:this.other},!0),n=JSON.stringify(t);return this.toString=()=>n,n},r.getPreparedQuery=function(){var t={rxQuery:this,mangoQuery:we(this.collection.schema.jsonSchema,this.mangoQuery)};t.mangoQuery.selector._deleted={$eq:!1},t.mangoQuery.index&&t.mangoQuery.index.unshift("_deleted"),F("prePrepareQuery",t);var n=$t(this.collection.schema.jsonSchema,t.mangoQuery);return this.getPreparedQuery=()=>n,n},r.doesDocumentDataMatch=function(t){return t._deleted?!1:this.queryMatcher(t)},r.remove=async function(){var t=await this.exec();if(Array.isArray(t)){var n=await this.collection.bulkRemove(t);if(n.error.length>0)throw Lt(n.error[0]);return n.success}else return t.remove()},r.incrementalRemove=function(){return le(this.asRxQuery,t=>t.incrementalRemove())},r.update=function(t){throw k("update")},r.patch=function(t){return le(this.asRxQuery,n=>n.patch(t))},r.incrementalPatch=function(t){return le(this.asRxQuery,n=>n.incrementalPatch(t))},r.modify=function(t){return le(this.asRxQuery,n=>n.modify(t))},r.incrementalModify=function(t){return le(this.asRxQuery,n=>n.incrementalModify(t))},r.where=function(t){throw k("query-builder")},r.sort=function(t){throw k("query-builder")},r.skip=function(t){throw k("query-builder")},r.limit=function(t){throw k("query-builder")},ce(e,[{key:"$",get:function(){if(!this._$){var a=this.collection.eventBulks$.pipe(I(t=>!t.isLocal),qt(null),de(()=>Et(this)),H(()=>this._result),Jt(Ht),He((t,n)=>!!(t&&t.time===D(n).time)),I(t=>!!t),H(t=>D(t).getValue()));this._$=la(a,this.refCount$.pipe(I(()=>!1)))}return this._$}},{key:"$$",get:function(){var a=this.collection.database.getReactivityFactory();return a.fromObservable(this.$,void 0,this.collection.database)}},{key:"queryMatcher",get:function(){var a=this.collection.schema.jsonSchema,t=we(this.collection.schema.jsonSchema,this.mangoQuery);return K(this,"queryMatcher",Wt(a,t))}},{key:"asRxQuery",get:function(){return this}}])})();function _e(){return{selector:{}}}function Dn(e){return e.collection._queryCache.getByQuery(e)}function fe(e,r,a,t){F("preCreateRxQuery",{op:e,queryObj:r,collection:a,other:t});var n=new ar(e,r,a,t);return n=Dn(n),vn(a),n}function nr(e){var r=e.asRxQuery.collection._changeEventBuffer.getCounter();return e._latestChangeEvent>=r}async function Et(e){return e.collection.awaitBeforeReads.size>0&&await Promise.all(Array.from(e.collection.awaitBeforeReads).map(r=>r())),e.collection.database.closed||nr(e)?!1:(e._ensureEqualQueue=e._ensureEqualQueue.then(()=>En(e)),e._ensureEqualQueue)}function En(e){if(e._lastEnsureEqual=$(),e.collection.database.closed||nr(e))return oe;var r=!1,a=!1;if(e._latestChangeEvent===-1&&(a=!0),!a){var t=e.asRxQuery.collection._changeEventBuffer.getFrom(e._latestChangeEvent+1);if(t===null)a=!0;else{e._latestChangeEvent=e.asRxQuery.collection._changeEventBuffer.getCounter();var n=e.asRxQuery.collection._changeEventBuffer.reduceByLastOfDoc(t);if(e.op==="count"){var s=D(e._result).count,i=s;n.forEach(c=>{var h=c.previousDocumentData&&e.doesDocumentDataMatch(c.previousDocumentData),u=e.doesDocumentDataMatch(c.documentData);!h&&u&&i++,h&&!u&&i--}),i!==s&&(r=!0,e._setResultData(i))}else{var o=cn(e,n);o.runFullQueryAgain?a=!0:o.changed&&(r=!0,e._setResultData(o.newResults))}}}return a?e._execOverDatabase().then(c=>(e._latestChangeEvent=e.collection._changeEventBuffer.getCounter(),typeof c=="number"?((!e._result||c!==e._result.count)&&(r=!0,e._setResultData(c)),r):((!e._result||!Mr(e.collection.schema.primaryPath,c,e._result.docsData))&&(r=!0,e._setResultData(c)),r))):Promise.resolve(r)}async function In(e){var r=[],a=e.collection;if(e.isFindOneByIdQuery)if(Array.isArray(e.isFindOneByIdQuery)){var t=e.isFindOneByIdQuery;if(t=t.filter(u=>{var l=e.collection._docCache.getLatestDocumentDataIfExists(u);return l?(l._deleted||r.push(l),!1):!0}),t.length>0){var n=await a.storageInstance.findDocumentsById(t,!1);Pe(r,n)}}else{var s=e.isFindOneByIdQuery,i=e.collection._docCache.getLatestDocumentDataIfExists(s);if(!i){var o=await a.storageInstance.findDocumentsById([s],!1);o[0]&&(i=o[0])}i&&!i._deleted&&r.push(i)}else{var c=e.getPreparedQuery(),h=await a.storageInstance.query(c);r=h.documents}return r}function Cn(e,r){if(!r.skip&&r.selector&&Object.keys(r.selector).length===1&&r.selector[e]){var a=r.selector[e];if(typeof a=="string")return a;if(Object.keys(a).length===1&&typeof a.$eq=="string"||Object.keys(a).length===1&&Array.isArray(a.$eq)&&!a.$eq.find(t=>typeof t!="string"))return a.$eq}return!1}var ie="collection",lt="storage-token",Rn="rx-migration-status",Sn="rx-pipeline-checkpoint",Pn="RxInternalDocument",ft=Ye({version:0,title:Pn,primaryKey:{key:"id",fields:["context","key"],separator:"|"},type:"object",properties:{id:{type:"string",maxLength:200},key:{type:"string"},context:{type:"string",enum:[ie,lt,Rn,Sn,"OTHER"]},data:{type:"object",additionalProperties:!0}},indexes:[],required:["key","context","data"],additionalProperties:!1,sharding:{shards:1,mode:"collection"}});function Ie(e,r){return ue(ft,{key:e,context:r})}async function sr(e){var r=$t(e.schema,{selector:{context:ie,_deleted:{$eq:!1}},sort:[{id:"asc"}],skip:0}),a=await e.query(r),t=a.documents;return t}var ir="storageToken",On=Ie(ir,lt);async function Mn(e){var r=at(10),a=e.password?await e.hashFunction(JSON.stringify(e.password)):void 0,t={id:On,context:lt,key:ir,data:{rxdbVersion:e.rxdbVersion,token:r,instanceToken:e.token,passwordHash:a},_deleted:!1,_meta:Oe(),_rev:z(),_attachments:{}},n=[{document:t}],s=await e.internalStore.bulkWrite(n,"internal-add-storage-token");if(!s.error[0])return Z("id",n,s)[0];var i=D(s.error[0]);if(i.isError&&tt(i)){var o=i;if(!An(o.documentInDb.data.rxdbVersion,e.rxdbVersion))throw g("DM5",{args:{database:e.name,databaseStateVersion:o.documentInDb.data.rxdbVersion,codeVersion:e.rxdbVersion}});if(a&&a!==o.documentInDb.data.passwordHash)throw g("DB1",{passwordHash:a,existingPasswordHash:o.documentInDb.data.passwordHash});var c=o.documentInDb;return D(c)}throw i}function An(e,r){if(!e)return!1;var a=e.split(".")[0],t=r.split(".")[0];return a==="15"&&t==="16"?!0:a===t}async function ns(e,r,a){if(e.schema.version!==a.version)throw g("SNH",{schema:a,version:e.schema.version,name:e.name,collection:e,args:{storageCollectionName:r}});for(var t=$e(e.name,e.schema.jsonSchema),n=Ie(t,ie);;){var s=await Qt(e.database.internalStore,n),i=V(D(s)),o=i.data.connectedStorages.find(c=>c.collectionName===r&&c.schema.version===a.version);if(o)return;i.data.connectedStorages.push({collectionName:r,schema:a});try{await Ar(e.database.internalStore,{previous:D(s),document:i},"add-connected-storage-to-collection")}catch(c){if(!tt(c))throw c}}}function $e(e,r){return e+"-"+r.version}function ge(e,r){return r=L(r),r=Tr(e,r),typeof e.jsonSchema.primaryKey!="string"&&(r=Nr(e.primaryPath,e.jsonSchema,r)),r._meta=Oe(),Object.prototype.hasOwnProperty.call(r,"_deleted")||(r._deleted=!1),Object.prototype.hasOwnProperty.call(r,"_attachments")||(r._attachments={}),Object.prototype.hasOwnProperty.call(r,"_rev")||(r._rev=z()),r}async function Tn(e,r){r.multiInstance=e.multiInstance;var a=await e.storage.createStorageInstance(r);return a}async function or(e,r,a,t,n,s,i,o){var c=await sr(r),h=c.filter(f=>f.data.name===n),u=[];h.forEach(f=>{u.push({collectionName:f.data.name,schema:f.data.schema,isCollection:!0}),f.data.connectedStorages.forEach(m=>u.push({collectionName:m.collectionName,isCollection:!1,schema:m.schema}))});var l=new Set;if(u=u.filter(f=>{var m=f.collectionName+"||"+f.schema.version;return l.has(m)?!1:(l.add(m),!0)}),await Promise.all(u.map(async f=>{var m=await e.createStorageInstance({collectionName:f.collectionName,databaseInstanceToken:a,databaseName:t,multiInstance:s,options:{},schema:f.schema,password:i,devMode:T.isDevMode()});await m.remove(),f.isCollection&&await ve("postRemoveRxCollection",{storage:e,databaseName:t,collectionName:n})})),o){var p=h.map(f=>{var m=nt(f);return m._deleted=!0,m._meta.lwt=$(),m._rev=ne(a,f),{previous:f,document:m}});await r.bulkWrite(p,"rx-database-remove-collection-all")}}function q(e){if(e.closed)throw g("COL21",{collection:e.name,version:e.schema.version})}var Nn=(function(){function e(a){this.subs=[],this.counter=0,this.eventCounterMap=new WeakMap,this.buffer=[],this.limit=100,this.tasks=new Set,this.collection=a,this.subs.push(this.collection.eventBulks$.pipe(I(t=>!t.isLocal)).subscribe(t=>{this.tasks.add(()=>this._handleChangeEvents(t.events)),this.tasks.size<=1&&rt().then(()=>{this.processTasks()})}))}var r=e.prototype;return r.processTasks=function(){if(this.tasks.size!==0){var t=Array.from(this.tasks);t.forEach(n=>n()),this.tasks.clear()}},r._handleChangeEvents=function(t){var n=this.counter;this.counter=this.counter+t.length,t.length>this.limit?this.buffer=t.slice(t.length*-1):(Pe(this.buffer,t),this.buffer=this.buffer.slice(this.limit*-1));for(var s=n+1,i=this.eventCounterMap,o=0;o<t.length;o++){var c=t[o];i.set(c,s+o)}},r.getCounter=function(){return this.processTasks(),this.counter},r.getBuffer=function(){return this.processTasks(),this.buffer},r.getArrayIndexByPointer=function(t){this.processTasks();var n=this.buffer[0],s=this.eventCounterMap.get(n);if(t<s)return null;var i=t-s;return i},r.getFrom=function(t){this.processTasks();var n=[],s=this.getArrayIndexByPointer(t);if(s===null)return null;for(;;){var i=this.buffer[s];if(s++,i)n.push(i);else return n}},r.runFrom=function(t,n){this.processTasks();var s=this.getFrom(t);if(s===null)throw new Error("out of bounds");s.forEach(i=>n(i))},r.reduceByLastOfDoc=function(t){return this.processTasks(),t.slice(0)},r.close=function(){this.tasks.clear(),this.subs.forEach(t=>t.unsubscribe())},e})();function xn(e){return new Nn(e)}var Bn=new WeakMap;function Fn(e){var r=e.schema.getDocumentPrototype(),a=jn(e),t=st,n={};return[r,a,t].forEach(s=>{var i=Object.getOwnPropertyNames(s);i.forEach(o=>{var c=Object.getOwnPropertyDescriptor(s,o),h=!0;(o.startsWith("_")||o.endsWith("_")||o.startsWith("$")||o.endsWith("$"))&&(h=!1),typeof c.value=="function"?Object.defineProperty(n,o,{get(){return c.value.bind(this)},enumerable:h,configurable:!1}):(c.enumerable=h,c.configurable=!1,c.writable&&(c.writable=!1),Object.defineProperty(n,o,c))})}),n}function Ln(e){return re(Bn,e,()=>da(Fn(e)))}function qn(e,r,a){var t=va(r,e,T.deepFreezeWhenDevMode(a));return e._runHooksSync("post","create",a,t),F("postCreateRxDocument",t),t}function jn(e){var r={};return Object.entries(e.methods).forEach(([a,t])=>{r[a]=t}),r}var cr={isEqual(e,r,a){e=It(e),r=It(r);var t=De(qe(e),qe(r));return t},resolve(e){return e.realMasterState}};function It(e){return e._attachments||(e=L(e),e._attachments={}),e}var ur=["pre","post"],hr=["insert","save","remove","create"],Ct=!1,se=new Set,lr=(function(){function e(a,t,n,s,i={},o={},c={},h={},u={},l=rr,p={},f=cr){this.storageInstance={},this.timeouts=new Set,this.incrementalWriteQueue={},this.awaitBeforeReads=new Set,this._incrementalUpsertQueues=new Map,this.synced=!1,this.hooks={},this._subs=[],this._docCache={},this._queryCache=hn(),this.$={},this.checkpoint$={},this._changeEventBuffer={},this.eventBulks$={},this.onClose=[],this.closed=!1,this.onRemove=[],this.database=a,this.name=t,this.schema=n,this.internalStorageInstance=s,this.instanceCreationOptions=i,this.migrationStrategies=o,this.methods=c,this.attachments=h,this.options=u,this.cacheReplacementPolicy=l,this.statics=p,this.conflictHandler=f,Hn(this.asRxCollection),a&&(this.eventBulks$=a.eventBulks$.pipe(I(m=>m.collectionName===this.name))),this.database&&se.add(this)}var r=e.prototype;return r.prepare=async function(){if(!await xr()){for(var t=0;t<10&&se.size>vt;)t++,await this.promiseWait(30);if(se.size>vt)throw g("COL23",{database:this.database.name,collection:this.name,args:{existing:Array.from(se.values()).map(c=>({db:c.database?c.database.name:"",c:c.name}))}})}this.storageInstance=Ut(this.database,this.internalStorageInstance,this.schema.jsonSchema),this.incrementalWriteQueue=new fa(this.storageInstance,this.schema.primaryPath,(c,h)=>Gt(this,c,h),c=>this._runHooks("post","save",c)),this.$=this.eventBulks$.pipe(de(c=>Yt(c))),this.checkpoint$=this.eventBulks$.pipe(H(c=>c.checkpoint)),this._changeEventBuffer=xn(this.asRxCollection);var n;this._docCache=new pn(this.schema.primaryPath,this.eventBulks$.pipe(I(c=>!c.isLocal),H(c=>c.events)),c=>(n||(n=Ln(this.asRxCollection)),qn(this.asRxCollection,n,c)));var s=this.database.internalStore.changeStream().pipe(I(c=>{var h=this.name+"-"+this.schema.version,u=c.events.find(l=>l.documentData.context==="collection"&&l.documentData.key===h&&l.operation==="DELETE");return!!u})).subscribe(async()=>{await this.close(),await Promise.all(this.onRemove.map(c=>c()))});this._subs.push(s);var i=await this.database.storageToken,o=this.storageInstance.changeStream().subscribe(c=>{var h={id:c.id,isLocal:!1,internal:!1,collectionName:this.name,storageToken:i,events:c.events,databaseToken:this.database.token,checkpoint:c.checkpoint,context:c.context};this.database.$emit(h)});return this._subs.push(o),W},r.cleanup=function(t){throw q(this),k("cleanup")},r.migrationNeeded=function(){throw k("migration-schema")},r.getMigrationState=function(){throw k("migration-schema")},r.startMigration=function(t=10){return q(this),this.getMigrationState().startMigration(t)},r.migratePromise=function(t=10){return this.getMigrationState().migratePromise(t)},r.insert=async function(t){q(this);var n=await this.bulkInsert([t]),s=n.error[0];ke(this,t[this.schema.primaryPath],t,s);var i=D(n.success[0]);return i},r.insertIfNotExists=async function(t){var n=await this.bulkInsert([t]);if(n.error.length>0){var s=n.error[0];if(s.status===409){var i=s.documentInDb;return We(this._docCache,[i])[0]}else throw s}return n.success[0]},r.bulkInsert=async function(t){if(q(this),t.length===0)return{success:[],error:[]};var n=this.schema.primaryPath,s=new Set,i;if(this.hasHooks("pre","insert"))i=await Promise.all(t.map(d=>{var y=ge(this.schema,d);return this._runHooks("pre","insert",y).then(()=>(s.add(y[n]),{document:y}))}));else{i=new Array(t.length);for(var o=this.schema,c=0;c<t.length;c++){var h=t[c],u=ge(o,h);s.add(u[n]),i[c]={document:u}}}if(s.size!==t.length)throw g("COL22",{collection:this.name,args:{documents:t}});var l=await this.storageInstance.bulkWrite(i,"rx-collection-bulk-insert"),p,f=this,m={get success(){if(!p){var d=Z(f.schema.primaryPath,i,l);p=We(f._docCache,d)}return p},error:l.error};if(this.hasHooks("post","insert")){var v=new Map;i.forEach(d=>{var y=d.document;v.set(y[n],y)}),await Promise.all(m.success.map(d=>this._runHooks("post","insert",v.get(d.primary),d)))}return m},r.bulkRemove=async function(t){q(this);var n=this.schema.primaryPath;if(t.length===0)return{success:[],error:[]};var s;typeof t[0]=="string"?s=await this.findByIds(t).exec():(s=new Map,t.forEach(f=>s.set(f.primary,f)));var i=[],o=new Map;Array.from(s.values()).forEach(f=>{var m=f.toMutableJSON(!0);i.push(m),o.set(f.primary,m)}),await Promise.all(i.map(f=>{var m=f[this.schema.primaryPath];return this._runHooks("pre","remove",f,s.get(m))}));var c=i.map(f=>{var m=L(f);return m._deleted=!0,{previous:f,document:m}}),h=await this.storageInstance.bulkWrite(c,"rx-collection-bulk-remove"),u=Z(this.schema.primaryPath,c,h),l=[],p=u.map(f=>{var m=f[n],v=this._docCache.getCachedRxDocument(f);return l.push(v),m});return await Promise.all(p.map(f=>this._runHooks("post","remove",o.get(f),s.get(f)))),{success:l,error:h.error}},r.bulkUpsert=async function(t){q(this);var n=[],s=new Map;t.forEach(h=>{var u=ge(this.schema,h),l=u[this.schema.primaryPath];if(!l)throw g("COL3",{primaryPath:this.schema.primaryPath,data:u,schema:this.schema.jsonSchema});s.set(l,u),n.push(u)});var i=await this.bulkInsert(n),o=i.success.slice(0),c=[];return await Promise.all(i.error.map(async h=>{if(h.status!==409)c.push(h);else{var u=h.documentId,l=be(s,u),p=D(h.documentInDb),f=this._docCache.getCachedRxDocuments([p])[0],m=await f.incrementalModify(()=>l);o.push(m)}})),{error:c,success:o}},r.upsert=async function(t){q(this);var n=await this.bulkUpsert([t]);return ke(this.asRxCollection,t[this.schema.primaryPath],t,n.error[0]),n.success[0]},r.incrementalUpsert=function(t){q(this);var n=ge(this.schema,t),s=n[this.schema.primaryPath];if(!s)throw g("COL4",{data:t});var i=this._incrementalUpsertQueues.get(s);return i||(i=W),i=i.then(()=>$n(this,s,n)).then(o=>o.inserted?o.doc:Wn(o.doc,n)),this._incrementalUpsertQueues.set(s,i),i},r.find=function(t){q(this),F("prePrepareRxQuery",{op:"find",queryObj:t,collection:this}),t||(t=_e());var n=fe("find",t,this);return n},r.findOne=function(t){q(this),F("prePrepareRxQuery",{op:"findOne",queryObj:t,collection:this});var n;if(typeof t=="string")n=fe("findOne",{selector:{[this.schema.primaryPath]:t},limit:1},this);else{if(t||(t=_e()),t.limit)throw g("QU6");t=L(t),t.limit=1,n=fe("findOne",t,this)}return n},r.count=function(t){q(this),t||(t=_e());var n=fe("count",t,this);return n},r.findByIds=function(t){q(this);var n={selector:{[this.schema.primaryPath]:{$in:t.slice(0)}}},s=fe("findByIds",n,this);return s},r.exportJSON=function(){throw k("json-dump")},r.importJSON=function(t){throw k("json-dump")},r.insertCRDT=function(t){throw k("crdt")},r.addPipeline=function(t){throw k("pipeline")},r.addHook=function(t,n,s,i=!1){if(typeof s!="function")throw je("COL7",{key:n,when:t});if(!ur.includes(t))throw je("COL8",{key:n,when:t});if(!hr.includes(n))throw g("COL9",{key:n});if(t==="post"&&n==="create"&&i===!0)throw g("COL10",{when:t,key:n,parallel:i});var o=s.bind(this),c=i?"parallel":"series";this.hooks[n]=this.hooks[n]||{},this.hooks[n][t]=this.hooks[n][t]||{series:[],parallel:[]},this.hooks[n][t][c].push(o)},r.getHooks=function(t,n){return!this.hooks[n]||!this.hooks[n][t]?{series:[],parallel:[]}:this.hooks[n][t]},r.hasHooks=function(t,n){if(!this.hooks[n]||!this.hooks[n][t])return!1;var s=this.getHooks(t,n);return s?s.series.length>0||s.parallel.length>0:!1},r._runHooks=function(t,n,s,i){var o=this.getHooks(t,n);if(!o)return W;var c=o.series.map(h=>()=>h(s,i));return Br(c).then(()=>Promise.all(o.parallel.map(h=>h(s,i))))},r._runHooksSync=function(t,n,s,i){if(this.hasHooks(t,n)){var o=this.getHooks(t,n);o&&o.series.forEach(c=>c(s,i))}},r.promiseWait=function(t){var n=new Promise(s=>{var i=setTimeout(()=>{this.timeouts.delete(i),s()},t);this.timeouts.add(i)});return n},r.close=async function(){return this.closed?oe:(se.delete(this),await Promise.all(this.onClose.map(t=>t())),this.closed=!0,Array.from(this.timeouts).forEach(t=>clearTimeout(t)),this._changeEventBuffer&&this._changeEventBuffer.close(),this.database.requestIdlePromise().then(()=>this.storageInstance.close()).then(()=>(this._subs.forEach(t=>t.unsubscribe()),delete this.database.collections[this.name],ve("postCloseRxCollection",this).then(()=>!0))))},r.remove=async function(){await this.close(),await Promise.all(this.onRemove.map(t=>t())),await or(this.database.storage,this.database.internalStore,this.database.token,this.database.name,this.name,this.database.multiInstance,this.database.password,this.database.hashFunction)},ce(e,[{key:"insert$",get:function(){return this.$.pipe(I(a=>a.operation==="INSERT"))}},{key:"update$",get:function(){return this.$.pipe(I(a=>a.operation==="UPDATE"))}},{key:"remove$",get:function(){return this.$.pipe(I(a=>a.operation==="DELETE"))}},{key:"asRxCollection",get:function(){return this}}])})();function Hn(e){if(!Ct){Ct=!0;var r=Object.getPrototypeOf(e);hr.forEach(a=>{ur.map(t=>{var n=t+Ot(a);r[n]=function(s,i){return this.addHook(t,a,s,i)}})})}}function Wn(e,r){return e.incrementalModify(a=>r)}function $n(e,r,a){var t=e._docCache.getLatestDocumentDataIfExists(r);return t?Promise.resolve({doc:e._docCache.getCachedRxDocuments([t])[0],inserted:!1}):e.findOne(r).exec().then(n=>n?{doc:n,inserted:!1}:e.insert(a).then(s=>({doc:s,inserted:!0})))}async function Qn({database:e,name:r,schema:a,instanceCreationOptions:t={},migrationStrategies:n={},autoMigrate:s=!0,statics:i={},methods:o={},attachments:c={},options:h={},localDocuments:u=!1,cacheReplacementPolicy:l=rr,conflictHandler:p=cr}){var f={databaseInstanceToken:e.token,databaseName:e.name,collectionName:r,schema:a.jsonSchema,options:t,multiInstance:e.multiInstance,password:e.password,devMode:T.isDevMode()};F("preCreateRxStorageInstance",f);var m=await Tn(e,f),v=new lr(e,r,a,m,t,n,o,c,h,l,i,p);try{await v.prepare(),Object.entries(i).forEach(([d,y])=>{Object.defineProperty(v,d,{get:()=>y.bind(v)})}),F("createRxCollection",{collection:v,creator:{name:r,schema:a,storageInstance:m,instanceCreationOptions:t,migrationStrategies:n,methods:o,attachments:c,options:h,cacheReplacementPolicy:l,localDocuments:u,statics:i}}),s&&v.schema.version!==0&&await v.migratePromise()}catch(d){throw se.delete(v),await m.close(),d}return v}var fr=function(){var r=arguments.length>0&&arguments[0]!==void 0?arguments[0]:1;this._parallels=r||1,this._qC=0,this._iC=new Set,this._lHN=0,this._hPM=new Map,this._pHM=new Map};fr.prototype={isIdle:function(){return this._qC<this._parallels},lock:function(){this._qC++},unlock:function(){this._qC--,Qe(this)},wrapCall:function(r){var a=this;this._qC++;var t;try{t=r()}catch(n){throw this.unlock(),n}return!t.then||typeof t.then!="function"?(this.unlock(),t):t.then(function(n){return a.unlock(),n}).catch(function(n){throw a.unlock(),n})},requestIdlePromise:function(r){var a=this;r=r||{};var t,n=new Promise(function(o){return t=o}),s=function(){Be(a,n),t()};if(n._manRes=s,r.timeout){var i=setTimeout(function(){n._manRes()},r.timeout);n._timeoutObj=i}return this._iC.add(n),Qe(this),n},cancelIdlePromise:function(r){Be(this,r)},requestIdleCallback:function(r,a){var t=this._lHN++,n=this.requestIdlePromise(a);return this._hPM.set(t,n),this._pHM.set(n,t),n.then(function(){return r()}),t},cancelIdleCallback:function(r){var a=this._hPM.get(r);this.cancelIdlePromise(a)},clear:function(){var r=this;this._iC.forEach(function(a){return Be(r,a)}),this._qC=0,this._iC.clear(),this._hPM=new Map,this._pHM=new Map}};function Un(e){if(e._iC.size!==0){var r=e._iC.values(),a=r.next().value;a._manRes(),setTimeout(function(){return Qe(e)},0)}}function Be(e,r){if(r){if(r._timeoutObj&&clearTimeout(r._timeoutObj),e._pHM.has(r)){var a=e._pHM.get(r);e._hPM.delete(a),e._pHM.delete(r)}e._iC.delete(r)}}function Qe(e){e._tryIR||e._iC.size===0||(e._tryIR=!0,setTimeout(function(){if(!e.isIdle()){e._tryIR=!1;return}setTimeout(function(){if(!e.isIdle()){e._tryIR=!1;return}Un(e),e._tryIR=!1},0)},0))}var Ue=new Set,Rt=new Map,mt=(function(){function e(a,t,n,s,i,o,c=!1,h={},u,l,p,f,m,v){this.idleQueue=new fr,this.rxdbVersion=qr,this.storageInstances=new Set,this._subs=[],this.startupErrors=[],this.onClose=[],this.closed=!1,this.collections={},this.states={},this.eventBulks$=new X,this.closePromise=null,this.observable$=this.eventBulks$.pipe(de(d=>Yt(d))),this.storageToken=oe,this.storageTokenDocument=oe,this.emittedEventBulkIds=new jr(60*1e3),this.name=a,this.token=t,this.storage=n,this.instanceCreationOptions=s,this.password=i,this.multiInstance=o,this.eventReduce=c,this.options=h,this.internalStore=u,this.hashFunction=l,this.cleanupPolicy=p,this.allowSlowCount=f,this.reactivity=m,this.onClosed=v,this.name!=="pseudoInstance"&&(this.internalStore=Ut(this.asRxDatabase,u,ft),this.storageTokenDocument=Mn(this.asRxDatabase).catch(d=>this.startupErrors.push(d)),this.storageToken=this.storageTokenDocument.then(d=>d.data.token).catch(d=>this.startupErrors.push(d)))}var r=e.prototype;return r.getReactivityFactory=function(){if(!this.reactivity)throw g("DB14",{database:this.name});return this.reactivity},r.$emit=function(t){this.emittedEventBulkIds.has(t.id)||(this.emittedEventBulkIds.add(t.id),this.eventBulks$.next(t))},r.removeCollectionDoc=async function(t,n){var s=await Qt(this.internalStore,Ie($e(t,n),ie));if(!s)throw g("SNH",{name:t,schema:n});var i=nt(s);i._deleted=!0,await this.internalStore.bulkWrite([{document:i,previous:s}],"rx-database-remove-collection")},r.addCollections=async function(t){var n={},s={},i=[],o={};await Promise.all(Object.entries(t).map(async([u,l])=>{var p=u,f=l.schema;n[p]=f;var m=Qr(f,this.hashFunction);if(s[p]=m,this.collections[u])throw g("DB3",{name:u});var v=$e(u,f),d={id:Ie(v,ie),key:v,context:ie,data:{name:p,schemaHash:await m.hash,schema:m.jsonSchema,version:m.version,connectedStorages:[]},_deleted:!1,_meta:Oe(),_rev:z(),_attachments:{}};i.push({document:d});var y=Object.assign({},l,{name:p,schema:m,database:this}),w=L(l);w.database=this,w.name=u,F("preCreateRxCollection",w),y.conflictHandler=w.conflictHandler,o[p]=y}));var c=await this.internalStore.bulkWrite(i,"rx-database-add-collection");await zn(this),await Promise.all(c.error.map(async u=>{if(u.status!==409)throw g("DB12",{database:this.name,writeError:u});var l=D(u.documentInDb),p=l.data.name,f=s[p];if(l.data.schemaHash!==await f.hash)throw g("DB6",{database:this.name,collection:p,previousSchemaHash:l.data.schemaHash,schemaHash:await f.hash,previousSchema:l.data.schema,schema:D(n[p])})}));var h={};return await Promise.all(Object.keys(t).map(async u=>{var l=o[u],p=await Qn(l);h[u]=p,this.collections[u]=p,this[u]||Object.defineProperty(this,u,{get:()=>this.collections[u]})})),h},r.lockedRun=function(t){return this.idleQueue.wrapCall(t)},r.requestIdlePromise=function(){return this.idleQueue.requestIdlePromise()},r.exportJSON=function(t){throw k("json-dump")},r.addState=function(t){throw k("state")},r.importJSON=function(t){throw k("json-dump")},r.backup=function(t){throw k("backup")},r.leaderElector=function(){throw k("leader-election")},r.isLeader=function(){throw k("leader-election")},r.waitForLeadership=function(){throw k("leader-election")},r.migrationStates=function(){throw k("migration-schema")},r.close=function(){if(this.closePromise)return this.closePromise;var{promise:t,resolve:n}=mr(),s=i=>{this.onClosed&&this.onClosed(),this.closed=!0,n(i)};return this.closePromise=t,(async()=>{if(await ve("preCloseRxDatabase",this),this.eventBulks$.complete(),this._subs.map(i=>i.unsubscribe()),this.name==="pseudoInstance"){s(!1);return}return this.requestIdlePromise().then(()=>Promise.all(this.onClose.map(i=>i()))).then(()=>Promise.all(Object.keys(this.collections).map(i=>this.collections[i]).map(i=>i.close()))).then(()=>this.internalStore.close()).then(()=>s(!0))})(),t},r.remove=function(){return this.close().then(()=>Vn(this.name,this.storage,this.multiInstance,this.password))},ce(e,[{key:"$",get:function(){return this.observable$}},{key:"asRxDatabase",get:function(){return this}}])})();function Kn(e,r){if(Ue.has(dr(e,r)))throw g("DB8",{name:e,storage:r.name,link:"https://rxdb.info/rx-database.html#ignoreduplicate"})}function mr(){var e,r,a=new Promise((t,n)=>{e=t,r=n});return{promise:a,resolve:e,reject:r}}function dr(e,r){return r.name+"|"+e}async function vr(e,r,a,t,n,s){var i=await r.createStorageInstance({databaseInstanceToken:e,databaseName:a,collectionName:Lr,schema:ft,options:t,multiInstance:n,password:s,devMode:T.isDevMode()});return i}function ss({storage:e,instanceCreationOptions:r,name:a,password:t,multiInstance:n=!0,eventReduce:s=!0,ignoreDuplicate:i=!1,options:o={},cleanupPolicy:c,closeDuplicates:h=!1,allowSlowCount:u=!1,localDocuments:l=!1,hashFunction:p=Fr,reactivity:f}){F("preCreateRxDatabase",{storage:e,instanceCreationOptions:r,name:a,password:t,multiInstance:n,eventReduce:s,ignoreDuplicate:i,options:o,localDocuments:l});var m=dr(a,e),v=Rt.get(m)||new Set,d=mr(),y=Array.from(v),w=()=>{v.delete(d.promise),Ue.delete(m)};return v.add(d.promise),Rt.set(m,v),(async()=>{if(h&&await Promise.all(y.map(N=>N.catch(()=>null).then(x=>x&&x.close()))),i){if(!T.isDevMode())throw g("DB9",{database:a})}else Kn(a,e);Ue.add(m);var _=at(10),C=await vr(_,e,a,r,n,t),R=new mt(a,_,e,r,t,n,s,o,C,p,c,u,f,w);return await ve("createRxDatabase",{database:R,creator:{storage:e,instanceCreationOptions:r,name:a,password:t,multiInstance:n,eventReduce:s,ignoreDuplicate:i,options:o,localDocuments:l}}),R})().then(_=>{d.resolve(_)}).catch(_=>{d.reject(_),w()}),d.promise}async function Vn(e,r,a=!0,t){var n=at(10),s=await vr(n,r,e,{},a,t),i=await sr(s),o=new Set;i.forEach(h=>o.add(h.data.name));var c=Array.from(o);return await Promise.all(c.map(h=>or(r,s,n,e,h,a,t))),await ve("postRemoveRxDatabase",{databaseName:e,storage:r}),await s.remove(),c}function is(e){return e instanceof mt}async function zn(e){if(await e.storageToken,e.startupErrors[0])throw e.startupErrors[0]}var Jn={RxSchema:Vt.prototype,RxDocument:st,RxQuery:ar.prototype,RxCollection:lr.prototype,RxDatabase:mt.prototype},Fe=new Set,St=new Set;function os(e){if(F("preAddRxPlugin",{plugin:e,plugins:Fe}),!Fe.has(e)){{if(St.has(e.name))throw g("PL3",{name:e.name,plugin:e});Fe.add(e),St.add(e.name)}if(!e.rxdb)throw je("PL1",{plugin:e});e.init&&e.init(),e.prototypes&&Object.entries(e.prototypes).forEach(([r,a])=>a(Jn[r])),e.overwritable&&Object.assign(T,e.overwritable),e.hooks&&Object.entries(e.hooks).forEach(([r,a])=>{a.after&&pt[r].push(a.after),a.before&&pt[r].unshift(a.before)})}}async function Ce(e,r){var a=ue(e.input.metaInstance.schema,{isCheckpoint:"1",itemId:r}),t=await e.input.metaInstance.findDocumentsById([a],!1),n=t[0];if(e.lastCheckpointDoc[r]=n,n)return n.checkpointData}async function Re(e,r,a){e.checkpointQueue=e.checkpointQueue.then(async()=>{var t=e.lastCheckpointDoc[r];if(a&&!e.events.canceled.getValue()&&(!t||JSON.stringify(t.checkpointData)!==JSON.stringify(a))){var n={id:"",isCheckpoint:"1",itemId:r,_deleted:!1,_attachments:{},checkpointData:a,_meta:Oe(),_rev:z()};for(n.id=ue(e.input.metaInstance.schema,n);!e.events.canceled.getValue();){if(t&&(n.checkpointData=me([t.checkpointData,n.checkpointData])),n._meta.lwt=$(),n._rev=ne(await e.checkpointKey,t),e.events.canceled.getValue())return;var s=[{previous:t,document:n}],i=await e.input.metaInstance.bulkWrite(s,"replication-set-checkpoint"),o=Z(e.primaryPath,s,i)[0];if(o){e.lastCheckpointDoc[r]=o;return}else{var c=i.error[0];if(c.status!==409)throw c;t=D(c.documentInDb),n._rev=ne(await e.checkpointKey,t)}}}}),await e.checkpointQueue}async function Yn(e){var r=await e.hashFunction([e.identifier,e.forkInstance.databaseName,e.forkInstance.collectionName].join("||"));return"rx_storage_replication_"+r}function Pt(e,r,a,t,n){var s=Object.assign({},t,{_attachments:r&&t._attachments?t._attachments:{},_meta:a?t._meta:Object.assign({},n?n._meta:{},{lwt:$()}),_rev:a?t._rev:z()});return s._rev||(s._rev=ne(e,n)),s}function G(e,r,a){var t=L(e);return r||delete t._attachments,a||(delete t._meta,delete t._rev),t}function Ke(e,r){return e.hasAttachments?r.map(a=>{var t=V(a.document);return t.docData=qe(t.docData),{document:t,previous:a.previous}}):r}function Ve(e){for(;;)if(e.underlyingPersistentStorage)e=e.underlyingPersistentStorage;else return e}var Gn="RxReplicationProtocolMetaData";function cs(e,r){var a=Hr(e),t={title:Gn,primaryKey:{key:"id",fields:["itemId","isCheckpoint"],separator:"|"},type:"object",version:e.version,additionalProperties:!1,properties:{id:{type:"string",minLength:1,maxLength:a+2},isCheckpoint:{type:"string",enum:["0","1"],minLength:1,maxLength:1},itemId:{type:"string",maxLength:a>4?a:4},checkpointData:{type:"object",additionalProperties:!0},docData:{type:"object",properties:e.properties},isResolvedConflict:{type:"string"}},keyCompression:e.keyCompression,required:["id","isCheckpoint","itemId"]};r&&(t.encrypted=["docData"]);var n=Ye(t);return n}function pr(e,r){return e.input.metaInstance.findDocumentsById(r.map(a=>{var t=ue(e.input.metaInstance.schema,{itemId:a,isCheckpoint:"0"});return t}),!0).then(a=>{var t={};return Object.values(a).forEach(n=>{t[n.itemId]={docData:n.docData,metaDocument:n}}),t})}async function Se(e,r,a,t){var n=r[e.primaryPath],s=a?nt(a):{id:"",isCheckpoint:"0",itemId:n,docData:r,_attachments:{},_deleted:!1,_rev:z(),_meta:{lwt:0}};s.docData=r,t&&(s.isResolvedConflict=t),s._meta.lwt=$(),s.id=ue(e.input.metaInstance.schema,s),s._rev=ne(await e.checkpointKey,a);var i={previous:a,document:s};return i}async function Xn(e){if(e.input.initialCheckpoint&&e.input.initialCheckpoint.downstream){var r=await Ce(e,"down");r||await Re(e,"down",e.input.initialCheckpoint.downstream)}var a=await e.input.hashFunction(e.input.identifier),t=e.input.replicationHandler,n=0,s=[];function i(m){e.stats.down.addNewTask=e.stats.down.addNewTask+1;var v={time:n++,task:m};s.push(v),e.streamQueue.down=e.streamQueue.down.then(()=>{for(var d=[];s.length>0;){e.events.active.down.next(!0);var y=D(s.shift());if(!(y.time<c)){if(y.task==="RESYNC")if(d.length===0){d.push(y.task);break}else break;d.push(y.task)}}if(d.length!==0)return d[0]==="RESYNC"?h():u(d)}).then(()=>{e.events.active.down.next(!1),!e.firstSyncDone.down.getValue()&&!e.events.canceled.getValue()&&e.firstSyncDone.down.next(!0)})}if(i("RESYNC"),!e.events.canceled.getValue()){var o=t.masterChangeStream$.pipe(de(async m=>(await Ee(e.events.active.up.pipe(I(v=>!v))),m))).subscribe(m=>{e.stats.down.masterChangeStreamEmit=e.stats.down.masterChangeStreamEmit+1,i(m)});Ee(e.events.canceled.pipe(I(m=>!!m))).then(()=>o.unsubscribe())}var c=-1;async function h(){if(e.stats.down.downstreamResyncOnce=e.stats.down.downstreamResyncOnce+1,!e.events.canceled.getValue()){e.checkpointQueue=e.checkpointQueue.then(()=>Ce(e,"down"));for(var m=await e.checkpointQueue,v=[];!e.events.canceled.getValue();){c=n++;var d=await t.masterChangesSince(m,e.input.pullBatchSize);if(d.documents.length===0||(m=me([m,d.checkpoint]),v.push(f(d.documents,m)),d.documents.length<e.input.pullBatchSize))break}await Promise.all(v)}}function u(m){e.stats.down.downstreamProcessChanges=e.stats.down.downstreamProcessChanges+1;var v=[],d=null;return m.forEach(y=>{if(y==="RESYNC")throw new Error("SNH");Pe(v,y.documents),d=me([d,y.checkpoint])}),f(v,D(d))}var l=W,p={docs:{}};function f(m,v){var d=e.primaryPath;return e.stats.down.persistFromMaster=e.stats.down.persistFromMaster+1,m.forEach(y=>{var w=y[d];p.docs[w]=y}),p.checkpoint=v,l=l.then(()=>{var y=p.docs;p.docs={};var w=p.checkpoint,_=Object.keys(y);if(e.events.canceled.getValue()||_.length===0)return W;var C=[],R={},N={},x=[];return Promise.all([e.input.forkInstance.findDocumentsById(_,!0),pr(e,_)]).then(([J,j])=>{var Q=new Map;return J.forEach(O=>Q.set(O[d],O)),Promise.all(_.map(async O=>{var E=Q.get(O),U=E?G(E,e.hasAttachments,!1):void 0,S=y[O],P=j[O];P&&E&&P.metaDocument.isResolvedConflict===E._rev&&await e.streamQueue.up;var ee=!P||!U?!1:e.input.conflictHandler.isEqual(P.docData,U,"downstream-check-if-equal-0");if(!ee&&P&&P.docData._rev&&E&&E._meta[e.input.identifier]&&ae(E._rev)===E._meta[e.input.identifier]&&(ee=!0),E&&P&&ee===!1||E&&!P)return W;var he=U?e.input.conflictHandler.isEqual(S,U,"downstream-check-if-equal-1"):!1;if(U&&he)return(!P||ee===!1)&&x.push(await Se(e,U,P?P.metaDocument:void 0)),W;var Y=Object.assign({},S,E?{_meta:L(E._meta),_attachments:e.hasAttachments&&S._attachments?S._attachments:{},_rev:z()}:{_meta:{lwt:$()},_rev:z(),_attachments:e.hasAttachments&&S._attachments?S._attachments:{}});if(S._rev){var Me=E?ae(E._rev)+1:1;Y._meta[e.input.identifier]=Me,e.input.keepMeta&&(Y._rev=S._rev)}e.input.keepMeta&&S._meta&&(Y._meta=S._meta);var b={previous:E,document:Y};b.document._rev=b.document._rev?b.document._rev:ne(a,b.previous),C.push(b),R[O]=b,N[O]=await Se(e,S,P?P.metaDocument:void 0)}))}).then(async()=>{if(C.length>0)return e.input.forkInstance.bulkWrite(C,await e.downstreamBulkWriteFlag).then(J=>{var j=Z(e.primaryPath,C,J);j.forEach(O=>{var E=O[d];e.events.processed.down.next(R[E]),x.push(N[E])});var Q;if(J.error.forEach(O=>{if(O.status!==409){var E=g("RC_PULL",{writeError:O});e.events.error.next(E),Q=E}}),Q)throw Q})}).then(()=>{if(x.length>0)return e.input.metaInstance.bulkWrite(Ke(e,x),"replication-down-write-meta").then(J=>{J.error.forEach(j=>{e.events.error.next(g("RC_PULL",{id:j.documentId,writeError:j}))})})}).then(()=>{Re(e,"down",w)})}).catch(y=>e.events.error.next(y)),l}}async function Zn(e,r,a){var t=e.input.conflictHandler,n=t.isEqual(r.realMasterState,r.newDocumentState,"replication-resolve-conflict");if(!n){var s=await t.resolve(r,"replication-resolve-conflict"),i=Object.assign({},s,{_meta:L(a._meta),_rev:z(),_attachments:L(a._attachments)});return i._meta.lwt=$(),i._rev=ne(await e.checkpointKey,a),i}}async function ze(e,r,a,t){if(!a._attachments||t&&!t._attachments)throw new Error("_attachments missing");var n=a[e],s=new Set(t&&t._attachments?Object.keys(t._attachments):[]);return await Promise.all(Object.entries(a._attachments).map(async([i,o])=>{if((!s.has(i)||t&&D(t._attachments)[i].digest!==o.digest)&&!o.data){var c=await r.getAttachmentData(n,i,o.digest);o.data=c}})),a}async function es(e){if(e.input.initialCheckpoint&&e.input.initialCheckpoint.upstream){var r=await Ce(e,"up");r||await Re(e,"up",e.input.initialCheckpoint.upstream)}var a=e.input.replicationHandler;e.streamQueue.up=e.streamQueue.up.then(()=>u().then(()=>l()));var t=0,n=-1,s=[],i=oe,o={docs:{}},c=e.input.forkInstance.changeStream().subscribe(f=>{if(!e.events.paused.getValue())return e.stats.up.forkChangeStreamEmit=e.stats.up.forkChangeStreamEmit+1,s.push({task:f,time:t++}),e.events.active.up.getValue()||e.events.active.up.next(!0),e.input.waitBeforePersist?e.input.waitBeforePersist().then(()=>l()):l()}),h=a.masterChangeStream$.pipe(I(f=>f==="RESYNC")).subscribe(()=>{s.push({task:"RESYNC",time:t++}),l()});Ee(e.events.canceled.pipe(I(f=>!!f))).then(()=>{c.unsubscribe(),h.unsubscribe()});async function u(){if(e.stats.up.upstreamInitialSync=e.stats.up.upstreamInitialSync+1,!e.events.canceled.getValue()){e.checkpointQueue=e.checkpointQueue.then(()=>Ce(e,"up"));for(var f=await e.checkpointQueue,m=new Set,v=async function(){n=t++,m.size>3&&await Promise.race(Array.from(m));var w=await Kt(e.input.forkInstance,e.input.pushBatchSize,f);if(w.documents.length===0)return 1;f=me([f,w.checkpoint]);var _=p(w.documents,D(f));m.add(_),_.catch().then(()=>m.delete(_))};!e.events.canceled.getValue()&&!await v(););var d=await Promise.all(m),y=d.find(w=>!!w);y?await u():!e.firstSyncDone.up.getValue()&&!e.events.canceled.getValue()&&e.firstSyncDone.up.next(!0)}}function l(){if(e.events.canceled.getValue()||s.length===0){e.events.active.up.next(!1);return}e.stats.up.processTasks=e.stats.up.processTasks+1,e.events.active.up.next(!0),e.streamQueue.up=e.streamQueue.up.then(async()=>{for(var f=[],m;s.length>0;){var v=D(s.shift());if(!(v.time<n)){if(v.task==="RESYNC"){e.events.active.up.next(!1),await u();return}v.task.context!==await e.downstreamBulkWriteFlag&&Pe(f,v.task.events.map(d=>d.documentData)),m=me([m,v.task.checkpoint])}}if(await p(f,m),s.length===0)e.events.active.up.next(!1);else return l()})}function p(f,m){return e.stats.up.persistToMaster=e.stats.up.persistToMaster+1,f.forEach(v=>{var d=v[e.primaryPath];o.docs[d]=v}),o.checkpoint=m,i=i.then(async()=>{if(e.events.canceled.getValue())return!1;var v=o.docs;o.docs={};var d=o.checkpoint,y=Object.keys(v);function w(){return Re(e,"up",d)}if(y.length===0)return w(),!1;var _=await pr(e,y),C={},R=[],N={},x={};if(await Promise.all(y.map(async b=>{var M=v[b];x[b]=M;var B=G(M,e.hasAttachments,!!e.input.keepMeta),A=_[b];A&&A.metaDocument.isResolvedConflict!==M._rev&&e.input.conflictHandler.isEqual(A.docData,B,"upstream-check-if-equal")||A&&A.docData._rev&&ae(M._rev)===M._meta[e.input.identifier]||(R.push(b),C[b]={assumedMasterState:A?A.docData:void 0,newDocumentState:B},N[b]=await Se(e,B,A?A.metaDocument:void 0))})),R.length===0)return w(),!1;var J=Object.values(C),j=new Set,Q={},O=Wr(J,e.input.pushBatchSize);await Promise.all(O.map(async b=>{e.hasAttachments&&await Promise.all(b.map(async B=>{B.newDocumentState=await ze(e.primaryPath,e.input.forkInstance,V(B.newDocumentState),B.assumedMasterState)}));var M=await a.masterWrite(b);M.forEach(B=>{var A=B[e.primaryPath];j.add(A),Q[A]=B})}));var E=[];if(R.forEach(b=>{j.has(b)||(e.events.processed.up.next(C[b]),E.push(N[b]))}),e.events.canceled.getValue())return!1;E.length>0&&await e.input.metaInstance.bulkWrite(Ke(e,E),"replication-up-write-meta");var U=!1;if(j.size>0){e.stats.up.persistToMasterHadConflicts=e.stats.up.persistToMasterHadConflicts+1;var S=[],P={};if(await Promise.all(Object.entries(Q).map(([b,M])=>{var B=C[b],A={newDocumentState:B.newDocumentState,assumedMasterState:B.assumedMasterState,realMasterState:M};return Zn(e,A,x[b]).then(async pe=>{if(pe){e.events.resolvedConflicts.next({input:A,output:pe}),S.push({previous:x[b],document:pe});var dt=_[b];P[b]=await Se(e,D(M),dt?dt.metaDocument:void 0,pe._rev)}})})),S.length>0){U=!0,e.stats.up.persistToMasterConflictWrites=e.stats.up.persistToMasterConflictWrites+1;var ee=await e.input.forkInstance.bulkWrite(S,"replication-up-write-conflict"),he;if(ee.error.forEach(b=>{if(b.status!==409){var M=g("RC_PUSH",{writeError:b});e.events.error.next(M),he=M}}),he)throw he;var Y=[],Me=Z(e.primaryPath,S,ee);Me.forEach(b=>{var M=b[e.primaryPath];Y.push(P[M])}),Y.length>0&&await e.input.metaInstance.bulkWrite(Ke(e,Y),"replication-up-write-conflict-meta")}}return w(),U}).catch(v=>(e.events.error.next(v),!1)),i}}function us(e){e=L(e),e.forkInstance=Ve(e.forkInstance),e.metaInstance=Ve(e.metaInstance);var r=Yn(e),a={primaryPath:Je(e.forkInstance.schema.primaryKey),hasAttachments:!!e.forkInstance.schema.attachments,input:e,checkpointKey:r,downstreamBulkWriteFlag:r.then(t=>"replication-downstream-"+t),events:{canceled:new te(!1),paused:new te(!1),active:{down:new te(!0),up:new te(!0)},processed:{down:new X,up:new X},resolvedConflicts:new X,error:new X},stats:{down:{addNewTask:0,downstreamProcessChanges:0,downstreamResyncOnce:0,masterChangeStreamEmit:0,persistFromMaster:0},up:{forkChangeStreamEmit:0,persistToMaster:0,persistToMasterConflictWrites:0,persistToMasterHadConflicts:0,processTasks:0,upstreamInitialSync:0}},firstSyncDone:{down:new te(!1),up:new te(!1)},streamQueue:{down:W,up:W},checkpointQueue:W,lastCheckpointDoc:{}};return Xn(a),es(a),a}function hs(e){return Ee(ta([e.firstSyncDone.down.pipe(I(r=>!!r)),e.firstSyncDone.up.pipe(I(r=>!!r))])).then(()=>{})}function ls(e){return Promise.all([e.streamQueue.up,e.streamQueue.down,e.checkpointQueue])}function fs(e,r,a,t=!1){e=Ve(e);var n=!!e.schema.attachments,s=Je(e.schema.primaryKey),i={masterChangeStream$:e.changeStream().pipe(de(async o=>{var c={checkpoint:o.checkpoint,documents:await Promise.all(o.events.map(async h=>{var u=G(h.documentData,n,t);return n&&(u=await ze(s,e,V(u),void 0)),u}))};return c})),masterChangesSince(o,c){return Kt(e,c,o).then(async h=>({checkpoint:h.documents.length>0?h.checkpoint:o,documents:await Promise.all(h.documents.map(async u=>{var l=G(u,n,t);return n&&(l=await ze(s,e,V(l),void 0)),l}))}))},async masterWrite(o){var c={};o.forEach(v=>{var d=v.newDocumentState[s];c[d]=v});var h=Object.keys(c),u=await e.findDocumentsById(h,!0),l=new Map;u.forEach(v=>l.set(v[s],v));var p=[],f=[];if(await Promise.all(Object.entries(c).map(([v,d])=>{var y=l.get(v);y?y&&!d.assumedMasterState?p.push(G(y,n,t)):r.isEqual(G(y,n,t),D(d.assumedMasterState),"rxStorageInstanceToReplicationHandler-masterWrite")===!0?f.push({previous:y,document:Pt(a,n,t,d.newDocumentState,y)}):p.push(G(y,n,t)):f.push({document:Pt(a,n,t,d.newDocumentState)})})),f.length>0){var m=await e.bulkWrite(f,"replication-master-write");m.error.forEach(v=>{if(v.status!==409)throw g("SNH",{name:"non conflict error",error:v});p.push(G(D(v.documentInDb),n,t))})}return p}};return i}async function ms(e){e.events.canceled.next(!0),e.events.active.up.complete(),e.events.active.down.complete(),e.events.processed.up.complete(),e.events.processed.down.complete(),e.events.resolvedConflicts.complete(),e.events.canceled.complete(),await e.checkpointQueue}export{fs as $,Gt as A,ca as B,ua as C,Yt as D,Fn as E,Ln as F,qn as G,jn as H,ie as I,ar as J,_e as K,Dn as L,fe as M,In as N,se as O,Cn as P,Dt as Q,mt as R,ir as S,Vt as T,$r as U,as as V,Qr as W,us as X,hs as Y,ls as Z,$e as _,os as a,ms as a0,Ce as a1,Re as a2,Yn as a3,Xn as a4,es as a5,Gn as a6,cs as a7,pr as a8,Se as a9,Zn as aa,Pt as ab,G as ac,Ke as ad,Ve as ae,cr as af,De as ag,k as ah,rs as ai,un as aj,hn as ak,bt as al,ln as am,fn as an,mn as ao,dn as ap,rr as aq,xe as ar,vn as as,te as at,Jt as au,Ee as av,pn as aw,fa as ax,He as ay,ss as b,vr as c,lt as d,zn as e,Rn as f,Sn as g,Pn as h,is as i,ft as j,Ie as k,sr as l,On as m,Mn as n,An as o,ns as p,lr as q,Vn as r,Qn as s,ge as t,Tn as u,or as v,q as w,st as x,da as y,va as z};
