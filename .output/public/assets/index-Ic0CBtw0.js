import{aX as te,aY as we,aZ as ae,a_ as D,a$ as be,aj as ne,aC as re,aw as T,az as P,ak as se,ah as De,ai as Se,A as Ce,b0 as _,b1 as p,aE as b,aF as A,n as L,aW as ye,o as m,z as R,i as W,y as ie,aa as oe,a9 as ce,N as $,aV as Re,p as Ie,c as Me,aq as Ee,u as xe,b2 as ue,b3 as F,K as Oe,b4 as Ne,Q as Te,b as Pe,at as Q,aB as K}from"./broadcast-channel-K9QvgciB.js";import{at as ke,V as Ae,k as le,I as Be,f as E,au as B,av as x,p as We,ai as $e,ag as Fe,a7 as j,$ as Qe,af as H,X as Ke,Y as je,Z as He,a0 as Ve,a6 as O,aw as Ue,ax as Ge,y as ze,ay as V,x as Ye,i as Je,B as Xe,a as qe}from"./index-BRb77N2c.js";function Ze(e){if(typeof WorkerGlobalScope=="function"&&self instanceof WorkerGlobalScope){var t=self.close.bind(self);self.close=function(){return e(),t()}}else{if(typeof window.addEventListener!="function")return;window.addEventListener("beforeunload",function(){e()},!0),window.addEventListener("unload",function(){e()},!0)}}function et(e){process.on("exit",function(){return e()}),process.on("beforeExit",function(){return e().then(function(){return process.exit()})}),process.on("SIGINT",function(){return e().then(function(){return process.exit()})}),process.on("uncaughtException",function(t){return e().then(function(){console.trace(t),process.exit(101)})})}var tt=Object.prototype.toString.call(typeof process<"u"?process:0)==="[object process]",at=tt?et:Ze,S=new Set,U=!1;function nt(){U||(U=!0,at(st))}function rt(e){if(nt(),typeof e!="function")throw new Error("Listener is no function");S.add(e);var t={remove:function(){return S.delete(e)},run:function(){return S.delete(e),e()}};return t}function st(){var e=[];return S.forEach(function(t){e.push(t()),S.delete(t)}),Promise.all(e)}function w(e,t){var a={context:"leader",action:t,token:e.token};return e.broadcastChannel.postInternal(a)}function he(e){e.isLeader=!0,e._hasLeader=!0;var t=rt(function(){return e.die()});e._unl.push(t);var a=function(r){r.context==="leader"&&r.action==="apply"&&w(e,"tell"),r.context==="leader"&&r.action==="tell"&&!e._dpLC&&(e._dpLC=!0,e._dpL(),w(e,"tell"))};return e.broadcastChannel.addEventListener("internal",a),e._lstns.push(a),w(e,"tell")}var de=function(t,a){var n=this;this.broadcastChannel=t,t._befC.push(function(){return n.die()}),this._options=a,this.isLeader=!1,this.isDead=!1,this.token=te(),this._lstns=[],this._unl=[],this._dpL=function(){},this._dpLC=!1,this._wKMC={},this.lN="pubkey-bc||"+t.method.type+"||"+t.name};de.prototype={hasLeader:function(){var t=this;return navigator.locks.query().then(function(a){var n=a.held?a.held.filter(function(r){return r.name===t.lN}):[];return!!(n&&n.length>0)})},awaitLeadership:function(){var t=this;if(!this._wLMP){this._wKMC.c=new AbortController;var a=new Promise(function(n,r){t._wKMC.res=n,t._wKMC.rej=r});this._wLMP=new Promise(function(n){navigator.locks.request(t.lN,{signal:t._wKMC.c.signal},function(){return t._wKMC.c=void 0,he(t),n(),a}).catch(function(){})})}return this._wLMP},set onduplicate(e){},die:function(){var t=this;return this._lstns.forEach(function(a){return t.broadcastChannel.removeEventListener("internal",a)}),this._lstns=[],this._unl.forEach(function(a){return a.remove()}),this._unl=[],this.isLeader&&(this.isLeader=!1),this.isDead=!0,this._wKMC.res&&this._wKMC.res(),this._wKMC.c&&this._wKMC.c.abort("LeaderElectionWebLock.die() called"),w(this,"death")}};var me=function(t,a){var n=this;this.broadcastChannel=t,this._options=a,this.isLeader=!1,this._hasLeader=!1,this.isDead=!1,this.token=te(),this._aplQ=ae,this._aplQC=0,this._unl=[],this._lstns=[],this._dpL=function(){},this._dpLC=!1;var r=function(i){i.context==="leader"&&(i.action==="death"&&(n._hasLeader=!1),i.action==="tell"&&(n._hasLeader=!0))};this.broadcastChannel.addEventListener("internal",r),this._lstns.push(r)};me.prototype={hasLeader:function(){return Promise.resolve(this._hasLeader)},applyOnce:function(t){var a=this;if(this.isLeader)return D(0,!0);if(this.isDead)return D(0,!1);if(this._aplQC>1)return this._aplQ;var n=function(){if(a.isLeader)return be;var s=!1,i,u=new Promise(function(c){i=function(){s=!0,c()}}),h=function(o){o.context==="leader"&&o.token!=a.token&&(o.action==="apply"&&o.token>a.token&&i(),o.action==="tell"&&(i(),a._hasLeader=!0))};a.broadcastChannel.addEventListener("internal",h);var l=t?a._options.responseTime*4:a._options.responseTime;return w(a,"apply").then(function(){return Promise.race([D(l),u.then(function(){return Promise.reject(new Error)})])}).then(function(){return w(a,"apply")}).then(function(){return Promise.race([D(l),u.then(function(){return Promise.reject(new Error)})])}).catch(function(){}).then(function(){return a.broadcastChannel.removeEventListener("internal",h),s?!1:he(a).then(function(){return!0})})};return this._aplQC=this._aplQC+1,this._aplQ=this._aplQ.then(function(){return n()}).then(function(){a._aplQC=a._aplQC-1}),this._aplQ.then(function(){return a.isLeader})},awaitLeadership:function(){return this._aLP||(this._aLP=it(this)),this._aLP},set onduplicate(e){this._dpL=e},die:function(){var t=this;return this._lstns.forEach(function(a){return t.broadcastChannel.removeEventListener("internal",a)}),this._lstns=[],this._unl.forEach(function(a){return a.remove()}),this._unl=[],this.isLeader&&(this._hasLeader=!1,this.isLeader=!1),this.isDead=!0,w(this,"death")}};function it(e){return e.isLeader?ae:new Promise(function(t){var a=!1;function n(){a||(a=!0,e.broadcastChannel.removeEventListener("internal",s),t(!0))}e.applyOnce().then(function(){e.isLeader&&n()});var r=function(){return D(e._options.fallbackInterval).then(function(){if(!(e.isDead||a))if(e.isLeader)n();else return e.applyOnce(!0).then(function(){e.isLeader?n():r()})})};r();var s=function(u){u.context==="leader"&&u.action==="death"&&(e._hasLeader=!1,e.applyOnce().then(function(){e.isLeader&&n()}))};e.broadcastChannel.addEventListener("internal",s),e._lstns.push(s)})}function ot(e,t){return e||(e={}),e=JSON.parse(JSON.stringify(e)),e.fallbackInterval||(e.fallbackInterval=3e3),e.responseTime||(e.responseTime=t.method.averageResponseTime(t.options)),e}function ct(e,t){if(e._leaderElector)throw new Error("BroadcastChannel already has a leader-elector");t=ot(t,e);var a=we()?new de(e,t):new me(e,t);return e._befC.push(function(){return a.die()}),e._leaderElector=a,a}async function fe(e){var t=Ae(e.collection.schema.jsonSchema).map(s=>e.collection.name+"-"+s),a=await e.database.internalStore.findDocumentsById(t.map(s=>le(s,Be)),!1),n={};a.forEach(s=>n[s.key]=s);var r=t.find(s=>n[s]);return r?n[r]:void 0}function ut(e,t,a){var n=T(a._attachments),r=P(a),s=r._meta;delete r._meta,r._attachments=n;for(var i=t+1,u=Promise.resolve(r),h=function(){var l=i;u=u.then(c=>lt(e,l,c)),i++};i<=e.schema.version;)h();return u.then(l=>l===null?se:(s&&(l._meta=s),l))}function lt(e,t,a){if(a===null)return se;var n=e.migrationStrategies[t](a,e),r=De(n);return r}async function ve(e){if(e.collection.schema.version===0)return ne;var t=await fe(e);return!!t}var ht=200,pe=new WeakMap;function dt(e){var t=ge(e.database),a=t.getValue().slice(0);a.push(e),t.next(a)}function ge(e){return re(pe,e,()=>new ke([]))}function mt(e){var t=pe.get(e);t&&t.complete()}var ft=(function(){function e(a,n,r=[a.name,"v",a.schema.version].join("-")){this.started=!1,this.canceled=!1,this.updateStatusHandlers=[],this.updateStatusQueue=Se,this.collection=a,this.migrationStrategies=n,this.statusDocKey=r,this.database=a.database,this.oldCollectionMeta=fe(this),this.mustMigrate=ve(this),this.statusDocId=le(this.statusDocKey,E),dt(this),this.$=Ce(this.database.internalStore,this.statusDocId).pipe(_(s=>!!s),p(s=>b(s).data),B(A))}var t=e.prototype;return t.getStatus=function(){return x(this.$)},t.startMigration=async function(n=ht){var r=await this.mustMigrate;if(r){if(this.started)throw L("DM1");if(this.started=!0,this.database.multiInstance){this.broadcastChannel=new ye(["rx-migration-state",this.database.name,this.collection.name,this.collection.schema.version].join("|"));var s=ct(this.broadcastChannel);await s.awaitLeadership()}var i=await this.oldCollectionMeta,u=await this.database.storage.createStorageInstance({databaseName:this.database.name,collectionName:this.collection.name,databaseInstanceToken:this.database.token,multiInstance:this.database.multiInstance,options:{},schema:b(i).data.schema,password:this.database.password,devMode:m.isDevMode()}),h=await this.getConnectedStorageInstances(),l=await this.countAllDocuments([u].concat(h.map(o=>o.oldStorage)));await this.updateStatus(o=>(o.count.total=l,o));try{await Promise.all(h.map(async o=>{await We(this.collection,o.newStorage.collectionName,o.newStorage.schema),await this.migrateStorage(o.oldStorage,o.newStorage,n),await o.newStorage.close()})),await this.migrateStorage(u,this.collection.storageInstance.originalStorageInstance,n)}catch(o){await u.close(),await this.updateStatus(f=>(f.status="ERROR",f.error=$e(o),f));return}try{await R(this.database.internalStore,{previous:i,document:Object.assign({},i,{_deleted:!0})},"rx-migration-remove-collection-meta")}catch(o){var c=W(o);if(!(c&&c.documentInDb._deleted))throw o}await this.updateStatus(o=>(o.status="DONE",o)),this.broadcastChannel&&await this.broadcastChannel.close()}},t.updateStatus=function(n){return this.updateStatusHandlers.push(n),this.updateStatusQueue=this.updateStatusQueue.then(async()=>{if(this.updateStatusHandlers.length!==0){var r=this.updateStatusHandlers;for(this.updateStatusHandlers=[];;){var s=await ie(this.database.internalStore,this.statusDocId),i=P(s);s||(i={id:this.statusDocId,key:this.statusDocKey,context:E,data:{collectionName:this.collection.name,status:"RUNNING",count:{total:0,handled:0,percent:0}},_deleted:!1,_meta:ce(),_rev:oe(),_attachments:{}});var u=b(i).data;for(var h of r)u=h(u);if(u.count.percent=Math.round(u.count.handled/u.count.total*100),i&&s&&Fe(i.data,s.data))break;try{await R(this.database.internalStore,{previous:s,document:b(i)},E);break}catch(l){if(!W(l))throw l}}}}),this.updateStatusQueue},t.migrateStorage=async function(n,r,s){this.collection.onClose.push(()=>this.cancel()),this.database.onClose.push(()=>this.cancel());var i=await this.database.storage.createStorageInstance({databaseName:this.database.name,collectionName:"rx-migration-state-meta-"+n.collectionName+"-"+n.schema.version,databaseInstanceToken:this.database.token,multiInstance:this.database.multiInstance,options:{},schema:j(n.schema,$(n.schema)),password:this.database.password,devMode:m.isDevMode()}),u=Qe(r,H,this.database.token,!0),h=Ke({keepMeta:!0,identifier:["rx-migration-state",n.collectionName,n.schema.version,this.collection.schema.version].join("-"),replicationHandler:{masterChangesSince(){return Promise.resolve({checkpoint:null,documents:[]})},masterWrite:async c=>{var o=await Promise.all(c.map(async d=>{var g=d.newDocumentState;if(r.schema.title===O&&(g=d.newDocumentState.docData,d.newDocumentState.isCheckpoint==="1"))return{assumedMasterState:void 0,newDocumentState:d.newDocumentState};var v=await ut(this.collection,n.schema.version,g);if(v===null)return null;var M={assumedMasterState:void 0,newDocumentState:r.schema.title===O?Object.assign({},d.newDocumentState,{docData:v}):v};return M}));o=o.filter(d=>!!d&&!!d.newDocumentState);var f=await u.masterWrite(o);return f},masterChangeStream$:new Re().asObservable()},forkInstance:n,metaInstance:i,pushBatchSize:s,pullBatchSize:0,conflictHandler:H,hashFunction:this.database.hashFunction}),l=!1;if(h.events.error.subscribe(c=>l=c),h.events.processed.up.subscribe(()=>{this.updateStatus(c=>(c.count.handled=c.count.handled+1,c))}),await je(h),await He(h),await this.updateStatusQueue,l)throw await i.close(),l;await Promise.all([n.remove(),i.remove()]),await this.cancel()},t.cancel=async function(){this.canceled=!0,this.replicationState&&await Ve(this.replicationState),this.broadcastChannel&&await this.broadcastChannel.close()},t.countAllDocuments=async function(n){var r=0;return await Promise.all(n.map(async s=>{var i=Ie(s.schema,Me(s.schema,{selector:{}})),u=await s.count(i);r+=u.count})),r},t.getConnectedStorageInstances=async function(){var n=b(await this.oldCollectionMeta),r=[];return await Promise.all(await Promise.all(n.data.connectedStorages.map(async s=>{if(s.schema.title!==O)throw new Error("unknown migration handling for schema");var i=j(P(this.collection.schema.jsonSchema),$(s.schema));i.version=this.collection.schema.version;var[u,h]=await Promise.all([this.database.storage.createStorageInstance({databaseInstanceToken:this.database.token,databaseName:this.database.name,devMode:m.isDevMode(),multiInstance:this.database.multiInstance,options:{},schema:s.schema,password:this.database.password,collectionName:s.collectionName}),this.database.storage.createStorageInstance({databaseInstanceToken:this.database.token,databaseName:this.database.name,devMode:m.isDevMode(),multiInstance:this.database.multiInstance,options:{},schema:i,password:this.database.password,collectionName:s.collectionName})]);r.push({oldStorage:u,newStorage:h})}))),r},t.migratePromise=async function(n){this.startMigration(n);var r=await this.mustMigrate;if(!r)return{status:"DONE",collectionName:this.collection.name,count:{handled:0,percent:0,total:0}};var s=await Promise.race([x(this.$.pipe(_(i=>i.status==="DONE"))),x(this.$.pipe(_(i=>i.status==="ERROR")))]);if(s.status==="ERROR")throw L("DM4",{collection:this.collection.name,error:s.error});return s},e})(),I=new WeakMap,k=new WeakMap;function C(e){var t=I.get(e);if(!t){var a=e.database?e.database:e,n=e.database?e.name:"";throw L("LD8",{database:a.name,collection:n})}return t}function _e(e,t,a,n,r,s){return t.createStorageInstance({databaseInstanceToken:e,databaseName:a,collectionName:vt(n),schema:Le,options:r,multiInstance:s,devMode:m.isDevMode()})}function G(e){var t=I.get(e);if(t)return I.delete(e),t.then(a=>a.storageInstance.close())}async function z(e,t,a){var n=Ee(10),r=await _e(n,e,t,a,{},!1);await r.remove()}function vt(e){return"plugin-local-documents-"+e}var Le=xe({title:"RxLocalDocument",version:0,primaryKey:"id",type:"object",properties:{id:{type:"string",maxLength:128},data:{type:"object",additionalProperties:!0}},required:["id","data"]});async function Y(e,t){var a=await C(this),n={id:e,data:t,_deleted:!1,_meta:ce(),_rev:oe(),_attachments:{}};return R(a.storageInstance,{document:n},"local-document-insert").then(r=>a.docCache.getCachedRxDocument(r))}function J(e,t){return this.getLocal(e).then(a=>{if(a)return a.incrementalModify(()=>t);var n=this.insertLocal(e,t);return n})}async function X(e){var t=await C(this),a=t.docCache,n=a.getLatestDocumentDataIfExists(e);return n?Promise.resolve(a.getCachedRxDocument(n)):ie(t.storageInstance,e).then(r=>r?t.docCache.getCachedRxDocument(r):null)}function q(e){return this.$.pipe(ue(null),F(async t=>{if(t)return{changeEvent:t};var a=await this.getLocal(e);return{doc:a}}),F(async t=>{if(t.changeEvent){var a=t.changeEvent;if(!a.isLocal||a.documentId!==e)return{use:!1};var n=await this.getLocal(e);return{use:!0,doc:n}}else return{use:!0,doc:t.doc}}),_(t=>t.use),p(t=>t.doc))}var pt=ze(),gt=(function(e){function t(a,n,r){var s;return s=e.call(this,null,n)||this,s.id=a,s.parent=r,s}return Ne(t,e),t})(pt),y={get isLocal(){return!0},get allAttachments$(){throw L("LD1",{document:this})},get primaryPath(){return"id"},get primary(){return this.id},get $(){var e=this,t=K(k,this.parent),a=this.primary;return e.parent.eventBulks$.pipe(_(n=>!!n.isLocal),p(n=>n.events.find(r=>r.documentId===a)),_(n=>!!n),p(n=>Xe(b(n))),ue(t.docCache.getLatestDocumentData(this.primary)),V((n,r)=>n._rev===r._rev),p(n=>t.docCache.getCachedRxDocument(n)),B(A))},get $$(){var e=this,t=N(e),a=t.getReactivityFactory();return a.fromObservable(e.$,e.getLatest()._data,t)},get deleted$$(){var e=this,t=N(e),a=t.getReactivityFactory();return a.fromObservable(e.deleted$,e.getLatest().deleted,t)},getLatest(){var e=K(k,this.parent),t=e.docCache.getLatestDocumentData(this.primary);return e.docCache.getCachedRxDocument(t)},get(e){if(e="data."+e,!!this._data){if(typeof e!="string")throw Pe("LD2",{objPath:e});var t=Q(this._data,e);return t=m.deepFreezeWhenDevMode(t),t}},get$(e){if(e="data."+e,m.isDevMode()){if(e.includes(".item."))throw L("LD3",{objPath:e});if(e===this.primaryPath)throw L("LD4")}return this.$.pipe(p(t=>t._data),p(t=>Q(t,e)),V())},get$$(e){var t=N(this),a=t.getReactivityFactory();return a.fromObservable(this.get$(e),this.getLatest().get(e),t)},async incrementalModify(e){var t=await C(this.parent);return t.incrementalWriteQueue.addWrite(this._data,async a=>(a.data=await e(a.data,this),a)).then(a=>t.docCache.getCachedRxDocument(a))},incrementalPatch(e){return this.incrementalModify(t=>(Object.entries(e).forEach(([a,n])=>{t[a]=n}),t))},async _saveData(e){var t=await C(this.parent),a=this._data;e.id=this.id;var n=[{previous:a,document:e}];return t.storageInstance.bulkWrite(n,"local-document-save-data").then(r=>{if(r.error[0])throw r.error[0];var s=Te(this.collection.schema.primaryPath,n,r)[0];e=T(e),e._rev=s._rev})},async remove(){var e=await C(this.parent),t=T(this._data);return t._deleted=!0,R(e.storageInstance,{previous:this._data,document:t},"local-document-remove").then(a=>e.docCache.getCachedRxDocument(a))}},Z=!1,_t=()=>{if(!Z){Z=!0;var e=Ye,t=Object.getOwnPropertyNames(e);t.forEach(n=>{var r=Object.getOwnPropertyDescriptor(y,n);if(!r){var s=Object.getOwnPropertyDescriptor(e,n);Object.defineProperty(y,n,s)}});var a=n=>()=>{throw L("LD6",{functionName:n})};["populate","update","putAttachment","putAttachmentBase64","getAttachment","allAttachments"].forEach(n=>y[n]=a(n))}};function Lt(e,t){_t();var a=new gt(e.id,e,t);return Object.setPrototypeOf(a,y),a.prototype=y,a}function N(e){var t=e.parent;return Je(t)?t:t.database}function ee(e){var t=e.database?e.database:e,a=e.database?e.name:"",n=(async()=>{var r=await _e(t.token,t.storage,t.name,a,t.instanceCreationOptions,t.multiInstance);r=Oe(t,r,Le);var s=new Ue("id",t.eventBulks$.pipe(_(c=>{var o=!1;return(a===""&&!c.collectionName||a!==""&&c.collectionName===a)&&(o=!0),o&&c.isLocal}),p(c=>c.events)),c=>Lt(c,e)),i=new Ge(r,"id",()=>{},()=>{}),u=await t.storageToken,h=r.changeStream().subscribe(c=>{for(var o=new Array(c.events.length),f=c.events,d=e.database?e.name:void 0,g=0;g<f.length;g++){var v=f[g];o[g]={documentId:v.documentId,collectionName:d,isLocal:!0,operation:v.operation,documentData:m.deepFreezeWhenDevMode(v.documentData),previousDocumentData:m.deepFreezeWhenDevMode(v.previousDocumentData)}}var M={id:c.id,isLocal:!0,internal:!1,collectionName:e.database?e.name:void 0,storageToken:u,events:o,databaseToken:t.token,checkpoint:c.checkpoint,context:c.context};t.$emit(M)});e._subs.push(h);var l={database:t,parent:e,storageInstance:r,docCache:s,incrementalWriteQueue:i};return k.set(e,l),l})();I.set(e,n)}var wt={name:"local-documents",rxdb:!0,prototypes:{RxCollection:e=>{e.insertLocal=Y,e.upsertLocal=J,e.getLocal=X,e.getLocal$=q},RxDatabase:e=>{e.insertLocal=Y,e.upsertLocal=J,e.getLocal=X,e.getLocal$=q}},hooks:{createRxDatabase:{before:e=>{e.creator.localDocuments&&ee(e.database)}},createRxCollection:{before:e=>{e.creator.localDocuments&&ee(e.collection)}},preCloseRxDatabase:{after:e=>G(e)},postCloseRxCollection:{after:e=>G(e)},postRemoveRxDatabase:{after:e=>z(e.storage,e.databaseName,"")},postRemoveRxCollection:{after:e=>z(e.storage,e.databaseName,e.collectionName)}},overwritable:{}},bt=new WeakMap,Dt={name:"migration-schema",rxdb:!0,init(){qe(wt)},hooks:{preCloseRxDatabase:{after:mt}},prototypes:{RxDatabase:e=>{e.migrationStates=function(){return ge(this).pipe(B(A))}},RxCollection:e=>{e.getMigrationState=function(){return re(bt,this,()=>new ft(this.asRxCollection,this.migrationStrategies))},e.migrationNeeded=function(){return this.schema.version===0?ne:ve(this.getMigrationState())}}}},yt=Dt;export{pe as DATA_MIGRATION_STATE_SUBJECT_BY_DATABASE,bt as DATA_MIGRATOR_BY_COLLECTION,ht as MIGRATION_DEFAULT_BATCH_SIZE,Dt as RxDBMigrationPlugin,yt as RxDBMigrationSchemaPlugin,ft as RxMigrationState,dt as addMigrationStateToDatabase,ge as getMigrationStateByDatabase,fe as getOldCollectionMeta,ut as migrateDocumentData,ve as mustMigrate,mt as onDatabaseClose,lt as runStrategyIfNotNull};
